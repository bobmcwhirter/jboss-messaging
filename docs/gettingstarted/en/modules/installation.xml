<chapter id="installation">

  <title>Installation</title>

  <para>As of today, JBoss Messaging is conflicting with the existing JBoss MQ server that ships with the JBoss 4.x and 5.x distributions. Therefore the provider is packaged as a scoped Service ARchive (.sar) <emphasis role="bold">named jboss-messaging-scoped.sar</emphasis> 
	</para>
	
  <section id="creatingserverconf">
    <title>Creating the server configuration</title>
    <para>We need to create a server configuration based on the <literal>default</literal> folder 
    </para>
		
    <programlisting>
      cd $JBOSS_HOME/server
      cp -r default messaging
    </programlisting>

	<para>
	  Note: The "all" configuration can be also used as a template. If you choose to base your configuration on "all", you will need to
	  adjust the steps 4.1, 4.2 and 4.3 accordingly, given the fact that in a clustered configuration, JBossMQ is deployed as a HASingleton under server/all/deploy-hasingleton/jms. 
	</para>
	
  </section>		

	
  <section id="configuringjmsra">
    <title>Configuring the JMS Resource adapter</title>
    <para>
	In jms-ds.xml, JBoss Messaging defines a connection factory bound by  the JMS Resource adapter at “java:/JmsXA”. Before we remove the whole jms folder (see 1.2.4) we need to move jms-rar.ar to /deploy
    </para>
		
   <programlisting>
     cd $JBOSS_HOME/server/messaging/deploy/jms
     cp jms-ra.rar ..
   </programlisting>
	
  </section>		

  <section id="removingjbossmq">
    <title>Removing JBossMQ</title>
    <para>
	 As aforementioned, JBossMQ should be taken out of the distribution.
	</para>
		
   <programlisting>
    cd $JBOSS_HOME/server/messaging/deploy
    rm -r jms
   </programlisting>
	
  </section>		

    
  <section id="configuringsecuritydomain">
    <title>Configuring the security domain</title>
    <para>
	 Modify $JBOSS_HOME/server/messaging/conf/login-config.xml security configuration file and add &lt;module-option name=&quot;unauthenticatedIdentity&quot;&gt;guest&lt;/module-option&gt; to the configuration of the UsersRolesLoginModule that is part of the JAAS stack of the "other" security domain. The correct configuration of the "other" security domain should be similar to:
	</para>
		
   <programlisting>
    
        &lt;application-policy name = &quot;other&quot;&gt;
            &lt;authentication&gt;
                &lt;login-module code = &quot;org.jboss.security.auth.spi.UsersRolesLoginModule&quot; flag = &quot;required&quot;&gt;
                    &lt;module-option name=&quot;unauthenticatedIdentity&quot;&gt;guest&lt;/module-option&gt;
                &lt;/login-module&gt;
            &lt;/authentication&gt;
        &lt;/application-policy&gt;
	
   </programlisting>

  </section>		

  <section id="deployingtheservice">
    <title>Deploying the service archive</title>
    <para>
	 You are now ready to deploy the provider. Please copy jboss-messaging-scoped.sar service archive to the messaging configuration's deployment directory.
	</para>
		
   <programlisting>
    cp jboss-messaging-scoped.sar $JBOSS_HOME/server/messaging/deploy
   </programlisting>
	
  </section>		

  <section id="startingtheservice">
    <title>Starting the server</title>
    <para>
	 To run the server, move to the JBOSS_DIST/bin directory and execute the run.bat or run.sh script as appropriate for your operating system.
	</para>
		
   <programlisting>
     cd $JBOSS_HOME/bin
     ./run.sh -c messaging
   </programlisting>
	
    <para>
	A successful JBoss Messaging deployment generates logging output similar to: 
    </para>
	
   <programlisting>
	....
	15:12:32,916 INFO  [JDBCPersistenceManager] creating tables
	15:12:34,628 INFO  [ServerPeer] JMS ServerPeer [server.0] started
	15:12:34,628 INFO  [ConnectionFactory] [/ConnectionFactory, /XAConnectionFactory, java:/ConnectionFactory, java:/XAConnectionFactory] deploy
	ed
	15:12:34,648 INFO  [Topic] Topic[/topic/testTopic] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,648 INFO  [Topic] Topic[/topic/securedTopic] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,648 INFO  [Topic] Topic[/topic/testDurableTopic] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,678 INFO  [Queue] Queue[/queue/testQueue] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,678 INFO  [Queue] Queue[/queue/DLQ] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,678 INFO  [Queue] Queue[/queue/A] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,678 INFO  [Queue] Queue[/queue/B] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,688 INFO  [Queue] Queue[/queue/C] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,688 INFO  [Queue] Queue[/queue/D] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	15:12:34,688 INFO  [Queue] Queue[/queue/ex] started, fullSize=75000, pageSize=2000, downCacheSize=1000
	....
   </programlisting>
	   			
  </section>		


  <section id="inst.validation">
    <title>Validation</title>

    <para>
      To validate the installation procedure, we will be running a basic example which send a persistent JMS message to a queue called queue/testQueue.
Navigate to the folder where you exploded the main archive and drill down to /examples/queue.
You need to use Apache Ant to execute the build.xml file
		
		[TODO]
		changing path to point at JBossAS installation
		
		
	</para>
		
   <programlisting>
   
	>ant
	Buildfile: build.xml
	
	init:
	
	compile:
		[javac] Compiling 1 source file to D:\tmp\JBossMessaging-1.0.0alpha-PR2.2\examples\queue\output
	
	run:
	 [unjar]  Expanding:  D:\tmp\distro\jboss-4.0.3SP1\server\messaging\deploy\jboss-messaging-scoped.sar  into D:\tmp\JBossMessaging-1.0.0alpha-PR2.2\examples\queue\output
	 [java]  Queue /queue/testQueue exists
	 [java]  FieldsManager in use =  org.jboss.serial.classmetamodel.UnsafeFieldsManager
	 [java]  19:14:30,201 INFO  @main [SocketServerInvoker] Invoker started for  locator: InvokerLocator [socket://192.168.4.86:2909/?dataType
	=jms&amp;marshaller=org.jboss.jms.server.remoting.JMSWireFormat&amp;serializationtype=jboss&amp;socket.check_connection=false&amp;socketTimeout=0&amp;unmarshall
	er=org.jboss.jms.server.remoting.JMSWireFormat]
	 [java]  The message was successfully sent to the testQueue queue
	 [java]  19:14:30,832 INFO  @main [SocketServerInvoker] Invoker started for  locator: InvokerLocator [socket://192.168.4.86:2910/?dataType
	=jms&amp;marshaller=org.jboss.jms.server.remoting.JMSWireFormat&amp;serializationtype=jboss&amp;socket.check_connection=false&amp;socketTimeout=0&amp;unmarshall
	er=org.jboss.jms.server.remoting.JMSWireFormat]
	 [java]  Received message: Hello!
	 [java]  The example connected to JBoss Messaging version 1.0.0alpha-PR2.2  (1.0)
	
	 [java]  #####################
	 [java]  ###    SUCCESS!   ###
	 [java]  #####################

   </programlisting>

  </section>






</chapter>
