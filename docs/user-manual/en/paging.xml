<?xml version="1.0" encoding="UTF-8"?>
<chapter id="paging">
    <title>Paging</title>
    <para>JBoss Messaging pages messages on disk, avoiding this way running out of Memory.</para>
    <para>Messages are regularly routed to their queues, persisted on disk for eventual recovery in
        case of server failure, sent to consumers or kept in memory if the consumers are not ready
        to read the messages.</para>
    <para>We compute the size of every message routed and stored in memory. When the total reaches a
        max configured size JBoss Messaging starts storing messages on disk. As messages are
        acknowledged and release the memory, we read the page and route messages to the destinations
        on memory.</para>
    <para>There are two page modes supported by JBoss Messaging. <link linkend="paging.global.mode"
            >Global Paging Mode </link> and <link linkend="paging.address.mode">Address Paging Mode
        </link></para>
    <section>
        <title>Page Files</title>
        <para>Messages are stored per address on the file system. Each address has an individual
            folder where messages are stored in multiple files (page files). Each file will contain
            messages up to a max configured size. (<literal>page-size-bytes</literal>). When reading
            page-files all messages on the page-file are read, routed and the file is deleted as
            soon as the messages are recovered.</para>
    </section>
    <section id="paging.global.mode">
        <title>Global Paging Mode</title>
        <para>JBoss Messaging enters into Global Paging Model when the total memory used by queues
            reaches a configured maximum value, determined by <literal><link
                    linkend="paging.main.config">paging-max-global-size-bytes</link></literal>. </para>
        <para>When the total memory is greater than <literal>paging-max-global-size-bytes</literal>,
            JBoss Messaging starts to page messages. When there is space in memory to fit a page
            file (<literal>global-page-size</literal>) messages are read and routed of the paging
            file.</para>
        <section id="paging.main.config">
            <title>Configuration</title>
            <para>Global paging parameters are specified on the main configuration file.</para>
            <programlisting>&lt;configuration xmlns="urn:jboss:messaging"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="urn:jboss:messaging /schema/jbm-configuration.xsd">

...

&lt;paging-max-global-size-bytes>20485760&lt;/paging-max-global-size-bytes>
&lt;paging-global-watermark-size>1048576&lt;/paging-global-watermark-size>

...        </programlisting>
            <para>
                <table frame="topbot">
                    <title>Paging Configuration Parameters</title>
                    <tgroup cols="3">
                        <colspec colname="c1" colnum="1"/>
                        <colspec colname="c2" colnum="2"/>
                        <colspec colname="c3" colnum="3"/>
                        <thead>
                            <row>
                                <entry>Property Name</entry>
                                <entry>Description</entry>
                                <entry>Default</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><literal>paging-directory</literal></entry>
                                <entry>Where page files are stored. JBoss Messaging will create one
                                    folder for each address being paged under this configured
                                    location.</entry>
                                <entry>data/paging</entry>
                            </row>
                            <row>
                                <entry><literal>paging-max-global-size-bytes</literal></entry>
                                <entry>JBoss Messaging enters into global page mode as soon as the
                                    total memory consumed by messages hits this value.</entry>
                                <entry>-1 (disabled)</entry>
                            </row>
                            <row>
                                <entry><literal>global-page-size</literal></entry>
                                <entry>The standard size of a page-file. JBoss Messaging will only
                                    read messages when there is enough space to read at least one
                                    page file, determined by this value.</entry>
                                <entry>10MiB (10 * 1024 * 1024 bytes)</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
        </section>
    </section>
    <section id="paging.address.mode">
        <title>Address Paging Mode</title>
        <para>It is possible to configured what's the maximum size individually at the address
            level. As soon as the address is consuming more memory than the maximum configured, that
            address alone goes into page mode.</para>
        <section>
            <title>Configuration</title>
            <para>Address level config is done at the address settings.</para>
            <programlisting>  &lt;address-settings>
      &lt;address-setting match="jms.someaddress">
         &lt;max-size-bytes>-1&lt;/max-size-bytes>
         &lt;page-size-bytes>10485760&lt;/page-size-bytes>
         &lt;drop-messages-when-full>10485760&lt;/drop-messages-when-full>
      &lt;/address-setting>
   &lt;/address-settings>
        </programlisting>
            <para>This is the list of available parameters on the address settings.</para>
            <para>
                <table frame="topbot">
                    <title>Paging Address Settings</title>
                    <tgroup cols="3">
                        <colspec colname="c1" colnum="1"/>
                        <colspec colname="c2" colnum="2"/>
                        <colspec colname="c3" colnum="3"/>
                        <thead>
                            <row>
                                <entry>Property Name</entry>
                                <entry>Description</entry>
                                <entry>Default</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><literal>max-size</literal></entry>
                                <entry>What's the max memory the address could have before entering
                                    on page mode.</entry>
                                <entry>-1 (disabled)</entry>
                            </row>
                            <row>
                                <entry><literal>page-size-bytes</literal></entry>
                                <entry>The size of each page file used on the paging system</entry>
                                <entry>10MiB (10 * 1024 * 1024 bytes)</entry>
                            </row>
                            <row>
                                <entry><literal>drop-messages-when-full</literal></entry>
                                <entry>if true, messages are dropped instead of paged when <literal
                                        >used-memory</literal> is greater than <literal
                                        >max-size</literal></entry>
                                <entry>false</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
        </section>
    </section>
    <section>
        <title>Caution with Addresses with Multiple Queues</title>
        <para>When a message is sent to multiple queues, on JMS Topics, or on Addresses with
            multiple queues, the same message is shared as a reference between multiple queues. The
            message only leaves the memory when it is consumed in all the queues.</para>
        <para>For example:</para>
        <itemizedlist>
            <listitem>
                <para>An Address has 10 queues </para>
            </listitem>
            <listitem>
                <para>It only has 9 consumers. One of the Queues is leaving messages on the
                    memory.</para>
            </listitem>
            <listitem>
                <para> Messages are continuously being produced</para>
            </listitem>
        </itemizedlist>
        <para>This will make memory to build on the server, and start paging mode eventually. Once
            the Address enters in page mode, messages will be stored on disk and not routed to
            queues until messages are consumed on that queue.</para>
    </section>
    <section>
        <title>Paging Example</title>
        <para>The <ulink url="../../../../examples/jms/paging/readme.html"><literal>Paging</literal>
                Example</ulink> shows how to JBoss Messaging avoids running out of memory.</para>
    </section>
</chapter>
