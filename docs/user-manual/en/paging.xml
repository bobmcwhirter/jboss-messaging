<?xml version="1.0" encoding="UTF-8"?>
<chapter id="paging">
    <title>Paging</title>
    <para>JBoss Messaging transparently supports huge queues containing millions of messages while
        the server is running with limited memory.</para>
    <para>In such a situation it's not possible to store all of the queues in memory at any one
        time, so JBoss Messaging transparently <emphasis>pages</emphasis> messages into and out of
        memory as they are needed, thus allowing massive queues with a low memory footprint.</para>
    <para>JBoss Messaging will start paging messages to disk, when either the size of the queue
        reaches a total configured maximum size.</para>
    <section>
        <title>Page Files</title>
        <para>Messages are stored per address on the file system. Each address has an individual
            folder where messages are stored in multiple files (page files). Each file will contain
            messages up to a max configured size (<literal>page-size-bytes</literal>). When reading
            page-files all messages on the page-file are read, routed and the file is deleted as
            soon as the messages are recovered.</para>
    </section>
    <section id="paging.main.config">
        <title>Configuration</title>
        <para>You can configure the location of the paging folder</para>
        <para>Global paging parameters are specified on the main configuration file.</para>
        <programlisting>&lt;configuration xmlns="urn:jboss:messaging"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="urn:jboss:messaging /schema/jbm-configuration.xsd">
            
            ...
            
            &lt;paging-directory>/somewhere/paging-directory&lt;/paging-directory>
            
            ...        </programlisting>
        <para>
            <table frame="topbot">
                <title>Paging Configuration Parameters</title>
                <tgroup cols="3">
                    <colspec colname="c1" colnum="1"/>
                    <colspec colname="c2" colnum="2"/>
                    <colspec colname="c3" colnum="3"/>
                    <thead>
                        <row>
                            <entry>Property Name</entry>
                            <entry>Description</entry>
                            <entry>Default</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry><literal>paging-directory</literal></entry>
                            <entry>Where page files are stored. JBoss Messaging will create one
                                folder for each address being paged under this configured
                                location.</entry>
                            <entry>data/paging</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </para>
    </section>
    <section id="paging.mode">
        <title>Paging Mode</title>
        <para>As soon as messages
            delivered to an address exceed the configured size, that address alone goes into page
            mode.</para>
        <section>
            <title>Configuration</title>
            <para>Configuration is done at the address settings.</para>
            <programlisting>  &lt;address-settings>
      &lt;address-setting match="jms.someaddress">
         &lt;max-size-bytes>-1&lt;/max-size-bytes>
         &lt;page-size-bytes>10485760&lt;/page-size-bytes>
         &lt;drop-messages-when-full>true&lt;/drop-messages-when-full>
      &lt;/address-setting>
   &lt;/address-settings>
        </programlisting>
            <para>This is the list of available parameters on the address settings.</para>
            <para>
                <table frame="topbot">
                    <title>Paging Address Settings</title>
                    <tgroup cols="3">
                        <colspec colname="c1" colnum="1"/>
                        <colspec colname="c2" colnum="2"/>
                        <colspec colname="c3" colnum="3"/>
                        <thead>
                            <row>
                                <entry>Property Name</entry>
                                <entry>Description</entry>
                                <entry>Default</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><literal>max-size-bytes</literal></entry>
                                <entry>What's the max memory the address could have before entering
                                    on page mode.</entry>
                                <entry>-1 (disabled)</entry>
                            </row>
                            <row>
                                <entry><literal>page-size-bytes</literal></entry>
                                <entry>The size of each page file used on the paging system</entry>
                                <entry>10MiB (10 * 1024 * 1024 bytes)</entry>
                            </row>
                            <row>
                                <entry><literal>drop-messages-when-full</literal></entry>
                                <entry>if true, messages are dropped instead of paged when <literal
                                        >used-memory</literal> is greater than <literal
                                        >max-size</literal></entry>
                                <entry>false</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
        </section>
    </section>
    <section>
        <title>Caution with Addresses with Multiple Queues</title>
        <para>When a message is routed to an address that has multiple queues bound to it, e.g. a
            JMS subscription, there is only 1 copy of the message in memory. Each queue only deals
            with a reference to this. Because of this the memory is only freed up once all queues
            referencing the message have delivered it. This means that if not all queues deliver the
            message we can end up in a state where messages are not delivered. </para>
        <para>For example:</para>
        <itemizedlist>
            <listitem>
                <para>An address has 10 queues </para>
            </listitem>
            <listitem>
                <para>One of the queues does not deliver its messages (maybe because of a slow
                    consumer).</para>
            </listitem>
            <listitem>
                <para>Messages continually arrive at the address and paging is started.</para>
            </listitem>
            <listitem>
                <para>The other 9 queues are empty even though messages have been sent.</para>
            </listitem>
        </itemizedlist>
        <para>In this example we have to wait until the last queue has delivered some of its
            messages before we depage and the other queues finally receive some more
            messages.</para>
    </section>
    <section>
        <title>Example</title>
        <para>See <xref linkend="examples.paging"/> for an example which shows how to use paging
            with JBoss Messaging.</para>
    </section>
</chapter>
