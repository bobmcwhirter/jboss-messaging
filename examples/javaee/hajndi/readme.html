<html>
  <head>
    <title>JBoss Messaging Java EE HAJNDI Example</title>
    <link rel="stylesheet" type="text/css" href="../../jms/common/common.css">
  </head>
  <body>
     <h1>Java EE HAJNDI Example</h1>
     <br>
     <p>This example demonstrates the use of High Availability JNDI (HA-JNDI) to look-up JBoss
     Messaging JMS Connection Factories, Queues and Topics.</p>
     <p>With normal JNDI you need to configure the client with the specific connection parameters
     (i.e. host and port) of the JNDI server from which you want to perform look-ups.</p>
     <p>This means if that server crashes, or is not available you won't be able to perform lookups.</p>
     <p>One solution would be for the client to maintain the connection params of all JNDI servers
     in the cluster, but this is not practicle.</p>
     <p>With HA-JNDI the client can be simplify configured with UDP address parameters and can transparently
     perform JNDI lookups without having to worry about a particular server being unavailable.</p>
     <p>HA-JNDI is a service of JBoss Application Server and is not available by default when running against
     a stand-alone JBoss Messaging instance.</>
     <p>An alternative approach is to avoid JNDI together and directly instantiate JMS Connection Factory,
     Queue and Topic instances on the client side. JBoss Messaging Connection Factory instances can
     also be configured to use UDP discovery so the specific details of the available servers are 
     not required on the client side.</p>
     <p>For more information on instantiating Connection Factory objects directly please see the user
     manual and the <i>Instantiate Connection Factory</i> example.</p>
     <p>For more information on HA-JNDI, please consult the <a href="http://www.jboss.org/file-access/default/members/jbossas/freezone/docs/Clustering_Guide/5/html/clustering-jndi.html">JBoss Application Server Clustering Documentation</a>.</p>
     <p>This example demonstrates a simple symmetric clustering configuration, and failover on JNDI (HAJNDI).</p>
     <h2>Please follow these steps to configure the example:</h2>
     <ol>
     <li>Define the property JBOSS_HOME pointing to the root of a JBoss 5.1 distribution</li>
     <li>Install JBoss Messaging by typing <code>ant</code> under <code>/messaging-distribution/AS</code></li>
     <li>Copy the directory $JBOSS_HOME/server/jbm2_symmetric as $JBOSS_HOME/server/jbm2_symmetric_2</li>
     <li>Start the first server with <code>./run.sh -c jbm2_symmetric</code></li>
     <li>Start the second server with <code>./run.sh -c jbm2_symmetric_2 -Djboss.service.binding.set=ports-01</li>
     </ol>
     <h1>Example step by step</h1>
     <ol>
        <li>Create a JNDI Context using HAJNDI Properties.
            <p>This JNDI is performing auto-discovery of the servers, by using the default UDP properties.</p>
            <p>You will find more information about these properties at the </p>
        </li>
        <pre>
           <code>         
         Hashtable jndiParameters = new Hashtable();
         jndiParameters.put("java.naming.factory.initial", "org.jnp.interfaces.NamingContextFactory");
         jndiParameters.put("java.naming.factory.url.pkgs=", "org.jboss.naming:org.jnp.interfaces");
         
         initialContext = new InitialContext(jndiParameters);
         </code>
        </pre>
        
        
        <li>Perform lookups in a loop. As long as you have at least one server alive, these lookups will still work fine
         <pre>
         <code>
         for (int i = 0; i < 100; i++)
         {
            ConnectionFactory cf = (ConnectionFactory) initialContext.lookup("/ConnectionFactory");
         </code>
         </pre>
        </li>

        <li>Create and close a JMS Connection, just to show the downloaded Connection Factory is working
        <pre>
        <code>
            connection = cf.createConnection();
            connection.close();
        </code>
        </pre>
        </li>
        
        
        <li>As the example sleeps here, use this time to kill one of the servers. You will realize that lookups will still work as long as you have a live server
        
        <pre>
        <code>
            System.out.println("Connection " + i + " was created and closed. If you kill any of the servers now, the lookup operation on Step 2 will still work fine");
            Thread.sleep(5000);
         }
        </code>
        </pre>
        </li>
        
        <li>And finally, <b>always</b> remember to close your JMS connections and resources after use, in a <code>finally</code> block. Closing a JMS connection will automatically close all of its sessions, consumers, producer and browser objects</li>

        <pre>
           <code>finally
           {
              if (initialContext != null)
              {
                initialContext.close();
              }
              if (connection != null)
              {
                 connection.close();
              }
           }</code>
        </pre>



     </ol>
  </body>
</html>