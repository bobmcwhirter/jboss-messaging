<html>
  <head>
    <title>JBoss Messaging JMS Bridge Example</title>
    <link rel="stylesheet" type="text/css" href="../../jms/common/common.css">
  </head>
  <body>
     <h1>JMS Bridge Example</h1>
     
     <p>This example shows how to configure and run a JMS Bridge in JBoss AS 5.<br />
         A bridge receives messages from a <em>source</em> JMS destination and resend them to a <em>target</em> destination.</p>
     <p>The source and target destinations can be on different servers, even from different JMS providers. For example, you can use this
         JMS Bridge to bridge a legacy JMS provider to JBoss Messaging during migration.</p>
         
     <p>This example will show how to configure and run the simplest bridge:</p>
     <ul>
         <li>the source and target destinations are hosted by a single JBoss AS 5 instance</li>
         <li>the bridge is run on the same JBoss AS 5 instance</li>
         <li>every time a message is consumed by the bridge from the source, it is resent to the target</li>
         <li>The application client will send a message to the source and consume the "same" message from the target to
             show that the two destinations were indeed bridged.</li>
     </ul>
     
     <h2>Example configuration</h2>

     <p>To run the example, you need to download JBoss AS 5.x and create a configuration for JBoss Messaging.</p>
         
     <h3>JBoss AS configuration</h3>
     
     <p>Please refer to JBoss Messaging documentation to deploy it for JBoss AS 5 <span class="missing-doc">add a link to the doc</span></p>

     <h3>JBoss Messaging configuration</h3>

     <p>We will add two queues to JBoss Messaging JMS configuration in 
         <code>${JBOSS_HOME}/server/default-with-jbm2/deploy/messaging.sar/jbm-jms.xml</code></p>
     <pre>
         <code>&lt;queue name="source"&gt;
            &lt;entry name="/queue/source"/&gt;
         &lt;/queue&gt;
         &lt;queue name="target"&gt;
            &lt;entry name="/queue/target"/&gt;
         &lt;/queue&gt;</code>
     </pre>
     
     <h3>JMS Bridge configuration</h3>

     <p>The JMS Bridge is configured using JBoss microcontainer (<a href="config/jms-bridge-jboss-beans.xml">jms-bridge-jboss-beans.xml</a> contains comments about the various parameters 
         used to configure the bridge).<br />
         To setup the bridge in JBoss AS 5, copy <a href="config/jms-bridge-jboss-beans.xml">jms-bridge-jboss-beans.xml</a> to <code>${JBOSS_HOME}/server/default-with-jbm2/deploy/</code></p>
         
     <h2>Example step-by-step</h2>

     <p><em>Once JBoss AS 5 is configured and started, type <code>ant</code> to run the example</em>.</p>
     
     <p>The example is simple: the application will send a message to the <em>source</em> queue and consume the same message
         from the <em>target</em> queue.</p>
     <p>The bridge was configured in <a href="config/jms-bridge-jboss-beans.xml">jms-bridge-jboss-beans.xml</a> to bridge these two queues.</p>
         
     <ol>
         <li>First we need to get an initial context so we can look up the JMS resources
         </li>
         <pre>
             <code>initialContext = new InitialContext();</code>
         </pre>

         <li>We look up the JMS ConnectionFactory</li>
         <pre>
             <code>ConnectionFactory cf = (ConnectionFactory)initialContext.lookup("/ConnectionFactory");</code>
         </pre>

         <p><em>First, we will send a message to the <em>source</em> queue</em>.</p>
         
         <li>We look up the JMS <em>source</em> queue</li>
         <pre>
             <code>Queue sourceQueue = (Queue)initialContext.lookup("/queue/source");</code>
         </pre>

         <li>We create a JMS connection, a session and a message producer for the <em>source</em> queue</li>
         <pre>
             <code>sourceConnection = cf.createConnection();
             Session sourceSession = sourceConnection.createSession(false, Session.AUTO_ACKNOWLEDGE);
             MessageProducer sourceProducer = sourceSession.createProducer(sourceQueue);</code>
         </pre>

         <li>We create and send a message to the <em>source</em> queue. We also display its Message ID.</li>
         <pre>
             <code>TextMessage message = sourceSession.createTextMessage("this is a text message");
             sourceProducer.send(message);
             System.out.format("Sent message to %s: %s\n",
                               ((Queue)message.getJMSDestination()).getQueueName(),
                               message.getText());
             System.out.format("Message ID : %s\n", message.getJMSMessageID());</code>
         </pre>

         <li>We close the <em>source</em> connection</li>
         <pre>
             <code>sourceConnection.close();</code>
         </pre>
         
         <p><em>Now that a message has been sent to the <em>source</em> queue, we will consume a message
             from the <em>target</em> queue.<br />
             If the bridge runs correctly, it will have consumed the message from the <em>source</em> and
             resent it to the <em>target</em> so that we can consume a message from it.</em></p>
             
         <li>We look up the JMS <em>target</em> queue</li>
         <pre>
             <code>Queue targetQueue = (Queue)initialContext.lookup("/queue/target");</code>
         </pre>

         <li>We create a connection, a session and a message consumer for the <em>target</em> queue</li>
         <pre>
             <code>targetConnection = cf.createConnection();
             Session targetSession = targetConnection.createSession(false, Session.AUTO_ACKNOWLEDGE);
             MessageConsumer targetConsumer = targetSession.createConsumer(targetQueue);</code>
         </pre>

         <li>We start the JMS connection to receive messages from the <em>target</em></li>
         <pre>
             <code>targetConnection.start();</code>
         </pre>

         <li>We receive a message from the <em>target</em> queue. It has the same content than the message sent to the <em>source</em> queue</li>
         <pre>
             <code>TextMessage messageReceived = (TextMessage)consumer.receive(5000);
             System.out.println("Received message: " + messageReceived.getText() +
                                         " (" +  messageReceived.getJMSMessageID() + ")");
             </code>
         </pre>
         
         <li>We now display the received message ID. It is not the same than the ID of the message sent to the <em>source</em> queue.
             The message received from the <em>target</em> queue was sent by the bridge, not by the <em>source</em> message producer</li>
         <pre>
             <code>System.out.format("Message ID         : %s\n", messageReceived.getJMSMessageID());</code>
         </pre>
         
         <li>If you need to retrieve the message ID of the message <em>sent to the source</em>, you can use the property <code>JBM_BRIDGE_MSG_ID_LIST</code></li>
         <pre>
             <code>System.out.format("Bridged Message ID : %s\n", messageReceived.getStringProperty("JBM_BRIDGE_MSG_ID_LIST"));</code>
         </pre>
        
         <li>And finally, <b>always</b> remember to close the JMS connections and resources after use, in a <code>finally</code> block. Closing a JMS connection will automatically close all of its sessions, consumers, producer and browser objects</li>

         <pre>
             <code>finally
             {
                if (initialContext != null)
                {
                   initialContext.close();
                }
                if (sourceConnection != null)
                {
                   sourceConnection.close();
                }
                if (targetConnection != null)
                {
                   targetConnection.close();
                }     
             }</code>
          </pre>
     </ol>
     
     <h2>More information</h2>
     
     <ul>
         <li><span class="missing-doc">JBoss Messsaging deployment in JBoss AS 5 </span></li>
         <li><span class="missing-doc">JMS Bridge configuration</a></li>
     </ul>

  </body>
</html>