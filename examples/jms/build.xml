<?xml version="1.0" encoding="UTF-8"?>

<!-- =========================================================================================== -->
<!--                                                                                             -->
<!-- JBoss, Home of Professional Open Source                                                     -->
<!-- Copyright 2005, JBoss Inc., and individual contributors as indicated                        -->
<!-- by the @authors tag. See the copyright.txt in the distribution for a                        -->
<!-- full listing of individual contributors.                                                    -->
<!--                                                                                             -->
<!-- This is free software; you can redistribute it and/or modify it                             -->
<!-- under the terms of the GNU Lesser General Public License as                                 -->
<!-- published by the Free Software Foundation; either version 2.1 of                            -->
<!-- the License, or (at your option) any later version.                                         -->
<!--                                                                                             -->
<!-- This software is distributed in the hope that it will be useful,                            -->
<!-- but WITHOUT ANY WARRANTY; without even the implied warranty of                              -->
<!-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU                            -->
<!-- Lesser General Public License for more details.                                             -->
<!--                                                                                             -->
<!-- You should have received a copy of the GNU Lesser General Public                            -->
<!-- License along with this software; if not, write to the Free                                 -->
<!-- Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA                          -->
<!-- 02110-1301 USA, or see the FSF site: http://www.fsf.org.                                    -->
<!--                                                                                             -->
<!-- =========================================================================================== -->


<!-- =========================================================================================== -->
<!--                                                                                             -->
<!-- $Id: build.xml 4037 2008-04-11 13:12:57Z ataylor $ -->
<!--                                                                                             -->
<!-- =========================================================================================== -->


<project default="help" name="JBoss Messaging JMS Examples">

   <property file="../build.properties"/>

   <property name="src.dir" value="src"/>
   <property name="config.dir" value="config"/>
   <property name="build.dir" value="build"/>

   <!--perf props-->
   <property name="message.count" value="200000"/>
   <property name="message.warmup.count" value="10000"/>
   <property name="delivery.mode" value="PERSISTENT"/>
   <!-- in seconds -->
   <property name="sample.period" value="1"/>
   <property name="sess.trans" value="false"/>
   <property name="sess.ackmode" value="DUPS_OK"/>
   <property name="sess.trans.size" value="1000"/>
   <property name="drain.queue" value="true"/>
   <property name="queue.lookup" value="/queue/testPerfQueue"/>
   <property name="cf.lookup" value="/ConnectionFactory"/>

   <path id="compile.classpath">
      <fileset dir="${lib.dir}">
         <include name="**/*.jar"/>
      </fileset>
      <pathelement location="${client.jar}"/>
   </path>

   <path id="runtime.classpath">
      <path refid="compile.classpath"/>
      <pathelement location="${build.dir}"/>
      <pathelement location="config"/>
   </path>

   <target name="help" description="-> display help">
      <echo>*****************************************************************</echo>
      <echo>* to run examples execute one of the following *</echo>
      <echo>* ant queueExample *</echo>
      <echo>* ant topicExample *</echo>
      <echo>* ant DurSubExample *</echo>
      <echo>* ant perfListener followed by ant perfSender *</echo>
      <echo>*****************************************************************</echo>
   </target>

   <target name="clean">
      <delete dir="${build.dir}"/>
   </target>

   <target name="init">
      <mkdir dir="${build.dir}"/>
   </target>


   <target name="compile" depends="init">
      <javac srcdir="${src.dir}" destdir="${build.dir}" debug="on"
             source="1.5">
         <classpath refid="compile.classpath"/>
      </javac>
   </target>

   <target name="queueExample" depends="compile" description="-> point to point example using a queue">
      <java classname="org.jboss.jms.example.QueueExample" fork="true">
         <classpath refid="runtime.classpath"/>
      </java>
   </target>

   <target name="topicExample" depends="compile" description="-> publish/subscribe example using a topic">
      <java classname="org.jboss.jms.example.TopicExample" fork="true">
         <classpath refid="runtime.classpath"/>
      </java>
   </target>

   <target name="DurSubExample" depends="compile"
           description="-> publish/subscribe example using a topic and a durable subscriber">
      <java classname="org.jboss.jms.example.DurableSubscriberExample" fork="true">
         <classpath refid="runtime.classpath"/>
      </java>
   </target>

   <target name="echo-params">
      <echo>
***********************************************************************************
* available parameters (-Dmessage.count=1000)
*
* parameter             description                      default               current
* ---------             -----------                      -------               -------
* message.count         number of messages               200000                ${message.count}
* message.warmup.count  number of messages to warm up    10000                 ${message.warmup.count}
* delivery.mode         PERSISTENT/NON_PERSISTENT        PERSISTENT            ${delivery.mode}
* sample.period         timing period in seconds         1                     ${sample.period}
* sess.trans            Is session transacted            true                  ${sess.trans}
* sess.trans.size       batch size to commit             1000                  ${sess.trans.size}
* sess.ackmode          Ack mode DUPS_OK/AUTO_ACK        DUPS_OK               ${sess.ackmode}
* drain.queue           drain the queue (listener only)  true                  ${drain.queue}
* queue.lookup          Queue JNDI lookup                /queue/testPerfQueue  ${queue.lookup}
* cf.lookup             ConnectionFactory JNDI lookup    /ConnectionFactory    ${cf.lookup}
***********************************************************************************
      </echo>
   </target>

   <target name="perfListener" depends="compile" description="-> run performance test when listening to a queue">
      <antcall target="echo-params"/>

      <java classname="org.jboss.jms.example.PerfExample" fork="true">
         <classpath refid="runtime.classpath"/>
         <jvmarg value="-Xmx1024M"/>
         <jvmarg value="-XX:+UseParallelGC"/>
         <jvmarg value="-XX:+AggressiveOpts"/>
         <jvmarg value="-XX:+UseFastAccessorMethods"/>
         <arg value="-l"/>
         <arg value="${message.count}"/>
         <arg value="${message.warmup.count}"/>
         <arg value="${delivery.mode}"/>
         <arg value="${sample.period}"/>
         <arg value="${sess.trans}"/>
         <arg value="${sess.trans.size}"/>
         <arg value="${sess.ackmode}"/>
         <arg value="${drain.queue}"/>
         <arg value="${queue.lookup}"/>
         <arg value="${cf.lookup}"/>
      </java>
   </target>


   <target name="perfSender" depends="compile" description="-> run performance test when sending to a queue">
      <antcall target="echo-params"/>
      <java classname="org.jboss.jms.example.PerfExample" fork="true">
         <classpath refid="runtime.classpath"/>
         <jvmarg value="-Xmx512M"/>
         <jvmarg value="-XX:+UseParallelGC"/>
         <jvmarg value="-XX:+AggressiveOpts"/>
         <jvmarg value="-XX:+UseFastAccessorMethods"/>
         <arg value="-s"/>
         <arg value="${message.count}"/>
         <arg value="${message.warmup.count}"/>
         <arg value="${delivery.mode}"/>
         <arg value="${sample.period}"/>
         <arg value="${sess.trans}"/>
         <arg value="${sess.trans.size}"/>
         <arg value="${sess.ackmode}"/>
         <arg value="false"/>
         <arg value="${queue.lookup}"/>
         <arg value="${cf.lookup}"/>
      </java>
   </target>

   <target name="perfNonTransactionalSender" depends="compile"
           description="-> run performance test when sending to a queue">
      <antcall target="perfSender">
         <param name="sess.trans" value="false"/>
      </antcall>
   </target>

   <target name="perfTransactionalSender" depends="compile"
           description="-> run performance test when sending to a queue">
      <antcall target="perfSender">
         <param name="sess.trans" value="true"/>
      </antcall>
   </target>

   <target name="perfAutoAckListener" depends="compile" description="-> run performance test when listening to a queue">
      <antcall target="perfListener">
         <param name="sess.ackmode" value="AUTO_ACK"/>
      </antcall>
   </target>

   <target name="perfDupsOKListener" depends="compile" description="-> run performance test when listening to a queue">
      <antcall target="perfListener">
         <param name="sess.ackmode" value="DUPS_OK"/>
      </antcall>
   </target>

   <target name="perfTransactionalListener" depends="compile"
           description="-> run performance test when listening to a queue">
      <antcall target="perfListener">
         <param name="sess.trans" value="true"/>
      </antcall>
   </target>
</project>
