<html>
  <head>
    <title>JBoss Messaging JMS Expiration Example</title>
    <link rel="stylesheet" type="text/css" href="../common/common.css">
  </head>
  <body>
     <h1>JMS Expiration Example</h1>

     <p>This example shows you how to define and deal with message expiration.</p>
     <p>Messages can be retained in the messaging system for a limited period of time before being removed.
         JMS specification states that clients should not receive messages that have been expired (but it does not guarantee this will not happen).</p>
     <p>JBoss Messaging can assign a <em>expiry destination</em> to a given queue so that when messages are expired, they are removed from the queue and sent
         to the expiry destination. These "expired" messages can later be consumed from the expiry destination for further inspection.
     <p>
         The example will send 1 message with a short <em>time-to-live</em> to a queue. We will wait for the message to expire and checks that the message
         is no longer in the queue it was sent to.
         We will instead consume it from an <em>expiry queue</em> where it was moved when it expired.
     </p>
     <h2>Example setup</h2>
     <p>Expiry destinations are defined as in the queue settings configuration file <a href="config/jbm-queues.xml">jbm-queues.xml</a>:</p>
     <pre>
         <code>&lt;address-settings match="jms.queue.exampleQueue"&gt;
            &lt;expiry-address&gt;jms.queue.expiryQueue&lt;/expiry-address&gt;
         &lt;/address-settings&gt;
     </pre>          
     <p>This configuration will moved expired messages from the <code>exampleQueue</code> to the <code>expiryQueue</code></p>
     <p>JBoss Messaging allows to specify either a <code>Queue</code> by prefixing the <code>expiry-address</code> with <code>jms.queue.</code>
         or a <code>Topic</code> by prefixing with <code>jms.topic.</code>.<br />
         In this example, we will use a <code>Queue</code> to hold the expired messages.</p>
     <p>Since we want to consume messages from this expiryQueue, we also need to add a JNDI binding to perform a lookup.
         This is configured in <a href="config/jbm-jms.xml">jbm-jms.xml</a></p>
     <pre>
         <code>&lt;queue name="expiryQueue"&gt;
            &lt;entry name="/queue/expiryQueue"/&gt;
         &lt;/queue&gt;</code>
     </pre>
     </p>
     <h2>Example step-by-step</h2>
     <p><i>To run the example, simply type <code>ant</code> from this directory</i></p>
     <ol>
        <li>First we need to get an initial context so we can look-up the JMS connection factory and destination objects from JNDI. This initial context will get it's properties from the <code>client-jndi.properties</code> file in the directory <code>../common/config</code></li>
        <pre>
           <code>InitialContext initialContext = getContext();</code>
        </pre>

        <li>We look up the JMS queue object from JNDI</li>
        <pre>
           <code>Queue queue = (Queue) initialContext.lookup("/queue/exampleQueue");</code>
        </pre>

        <li>We look up the JMS connection factory object from JNDI</li>
        <pre>
           <code>ConnectionFactory cf = (ConnectionFactory) initialContext.lookup("/ConnectionFactory");</code>
        </pre>

        <li>We create a JMS connection</li>
        <pre>
           <code>connection = cf.createConnection();</code>
        </pre>

        <li>We create a JMS session. The session is created as non transacted and will auto acknowledge messages</li>
        <pre>
           <code>Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);</code>
        </pre>

        <li>We create a JMS message producer on the session. This will be used to send the messages</li>
        <pre>
          <code>MessageProducer messageProducer = session.createProducer(topic);</code>
       </pre>
       
       <li>Messages sent by this producer will be retained for 1s (1000ms) before expiration</li>
       <pre>
           <code>producer.setTimeToLive(1000);</code>
       </pre>

        <li>We create a text messages</li>
        <pre>
            <code>TextMessage message = session.createTextMessage("this is a text message");</code>
        </pre>

        <li>We send the message to the queue</li>
        <pre>
            <code>producer.send(message);</code>
        </pre>
        
       <li>We sleep a little bit to let the message expire</li>
        <pre>
            <code>Thread.sleep(5000);</code>
        </pre>

        <p>We will now try to consume the message from the queue but it won't be there since it has expired</p>

        <li>We create a JMS message consumer on the queue</li>
        <pre>
            <code>MessageConsumer messageConsumer = session.createConsumer(queue);</code>
        </pre>
        
        <li>We start the connection. In order for delivery to occur on any consumers or subscribers on a connection, the connection must be started</li>
        <pre>
           <code>connection.start();</code>
        </pre>

        <li>We try to receive a message from the queue. Since there is none, the call will timeout after 5000ms and <code>messageReceived</code> will be <code>null</code>
        <pre>
           <code>TextMessage messageReceived = (TextMessage) messageConsumer.receive(5000);
           System.out.println("Received message from " + queue.getQueueName() + ": " + messageReceived);</code>
        </pre>
        
        <p>However, we have configured JBoss Messaging to send any expired messages to the <code>expiryQueue</code>.
            We will now consume messages from this expiry queue and receives the <em>expired</em> message.</p>
            
        <li>We look up the JMS <em>expiry queue</em> object from JNDI</li>
        <pre>
           <code>Queue expiryQueue = (Queue)initialContext.lookup("/queue/expiryQueue");</code>
        </pre>
                  
        <li>We create a JMS message consumer on the expiry queue</li>
        <pre>
            <code>MessageConsumer expiryConsumer = session.createConsumer(expiryQueue);</code>
        </pre>
        
        <li>We consume a message from the expiry queue:</li>
        <pre>
            <code>messageReceived = (TextMessage)expiryConsumer.receive(5000);</code>
        </pre>
        
        <li>The message consumed from the <em>expiry queue</em> has the <em>same content</em> than the message which was sent to the <em>queue</em>
        <pre>
            <code>System.out.println("Received message from " + expiryQueue.getQueueName() + ": " + messageReceived.getText());</code>
        </pre>    
            
        <p>JMS does not specify the notion of expiry queue. From JMS point of view, the message received from the expiry queue
            is a <strong>different</strong> message than the message expired from the queue: the two messages have the same content (properties and body) but
            their JMS headers differ.<br />
            JBoss Messaging defines additional properties to correlate the message received from the expiry queue with the 
            message expired from the queue</p>
            
        <li>The expired message's destination is the expiry queue</li>
        <pre>
            <code>System.out.println("Destination of the expired message: " + ((Queue)messageReceived.getJMSDestination()).getQueueName());</code>
        </pre>

        <li>The expired message has its own <em>expiration time</em> (its time to live in the <strong>expiry queue</strong>)</li>
        <pre>
            <code>System.out.println("Expiration time of the expired message (relative to the expiry queue): " + messageReceived.getJMSExpiration());</code>
        </pre>
        
        <p>As we have not defined a time-to-live for the expiry queue, messages sent to the expiry queue will be kept forever (their JMS Expiration value is 0)</p>

        <li>The <strong>origin destination</strong> is stored in the <code>_JBM_ORIG_DESTINATION</code> property
        <pre>
            <code>System.out.println("*Origin destination* of the expired message: " + messageReceived.getStringProperty("_JBM_ORIG_DESTINATION"));</code>
        </pre>

        <li>The <strong>actual expiration time</strong> (when the message was expired from the queue) is stored in the <code>_JBM_ACTUAL_EXPIRY</code> property
        <pre>
            <code>System.out.println("*Actual expiration time* of the expired message: " + messageReceived.getLongProperty("_JBM_ACTUAL_EXPIRY"));</code>
        </pre>

        </p>    
        <li>And finally, <b>always</b> remember to close your JMS connections and resources after use, in a <code>finally</code> block. Closing a JMS connection will automatically close all of its sessions, consumers, producer and browser objects</li>

        <pre>
           <code>finally
           {
              if (initialContext != null)
              {
                initialContext.close();
              }
              if (connection != null)
              {
                 connection.close();
              }
           }</code>
        </pre>


     </ol>
  </body>
</html>