<html>
  <head>
    <title>JBoss Messaging JMS Queue Example</title>
    <link rel="stylesheet" type="text/css" href="../common/common.css">
  </head>
  <body>
     <h1>JMS Queue Example</h1>
     <br>
     <p>This example shows you how to send and receive a message to a JMS Queue with JBoss Messaging.</p>
     <p>Queues are a standard part of JMS, please consult the JMS 1.1 specification for full details.</p>
     <p>A Queue is used to send messages point to point, from a producer to a consumer. The queue guarantees message ordering between these 2 points.</p>
     <br>
     <h2>Example step-by-step</h2>
     <p><i>To run the example, simply type <code>ant</code> from this directory</i></p>
     <br>
     <ol>
        <li>First we need to get an initial context so we can look-up the JMS connection factory and destination objects from JNDI. This initial context will get it's properties from the <code>client-jndi.properties</code> file in the directory <code>../common/config</code></li>
        <pre>
           <code>InitialContext initialContext = getContext();</code>
        </pre>

        <li>We look-up the JMS queue object from JNDI</li>
        <pre>
           <code>Queue queue = (Queue) initialContext.lookup("/queue/exampleQueue");</code>
        </pre>

        <li>Perform a lookup on the Connection Factory. This ConnectionFactory has a special set on this example (jbm-jms.xml). Messages with more than 10K are considered large.</li>
        <pre>
           <code>ConnectionFactory cf = (ConnectionFactory) initialContext.lookup("/ConnectionFactory");</code>
        </pre>

        <li>We create a JMS connection</li>
        <pre>
           <code>connection = cf.createConnection();</code>
        </pre>

        <li>We create a JMS session. The session is created as non transacted and will auto acknowledge messages.</li>
        <pre>
           <code>Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);</code>
        </pre>

        <li>We create a JMS message producer on the session. This will be used to send the messages.</li>
        <pre>
          <code>MessageProducer messageProducer = session.createProducer(topic);</code>
       </pre>

        <li>Create a BytesMessage</li>
        <pre><code>
         BytesMessage message = session.createBytesMessage();
        </code></pre>
        
        <li>Set the File Stream</li>
        <pre><code>
         FileInputStream fileInputStream = new FileInputStream(fileInput);
         BufferedInputStream bufferedInput = new BufferedInputStream(fileInputStream);
         ((JBossMessage)message).setInputStream(bufferedInput);
         </code></pre>
        

        <li>We send message to the queue. After the send completion the message file will be located at ./build/data/largeMessages</li>
        <pre>
           <code>messageProducer.send(message);</code>
        </pre>

        <li>We create a JMS Message Consumer to receive the message.</li>
          <pre>
           <code>MessageConsumer messageConsumer = session.createConsumer(queue);</code>
        </pre>

        <li>We start the connection. In order for delivery to occur on any consumers or subscribers on a connection, the connection must be started</li>
        <pre>
           <code>connection.start();</code>
        </pre>

        <li>Receive the message'</li>
        <pre><code>
        BytesMessage messageReceived = (BytesMessage) messageConsumer.receive(120000);
        System.out.println("Received message: " + messageReceived.getBodyLength() + " bytes");
        </code></pre>
        

         <li>Setting a stream to receive the message. You may choose to use the regular BytesMessage or STreamMessage interface but this method is much faster for large messages.</li>
        <pre><code>
         FileOutputStream fileOutputStream = new FileOutputStream(fileOutput);
         BufferedOutputStream bufferedOutput = new BufferedOutputStream(fileOutputStream);
         ((JBossMessage)messageReceived).setOutputStream(bufferedOutput);
        </code></pre>
         
         <li>setOutputStream is a non-blocking operation. You may choose to wait the streaming completion.</li> 
        <pre><code>
         ((JBossMessage)messageReceived).waitCompletionOnStream(300000);
        </code></pre>
        

        <li>And finally, <b>always</b> remember to close your JMS connections and resources after use, in a <code>finally</code> block. Closing a JMS connection will automatically close all of its sessions, consumers, producer and browser objects</li>

        <pre>
           <code>finally
           {
              if (initialContext != null)
              {
                initialContext.close();
              }
              if (connection != null)
              {
                 connection.close();
              }
           }</code>
        </pre>



     </ol>
  </body>
</html>