<html>
  <head>
    <title>JBoss Messaging JMS QueueRequestor Example</title>
    <link rel="stylesheet" type="text/css" href="../common/common.css">
  </head>
  <body>
     <h1>JMS QueueRequestor Example</h1>
     <br>
     <p>This example shows you how to use a QueueRequestor with JBoss Messaging.</p>
     <p>A QueueRequestor is a JMS utility object to simplify the use of request/reply.</p>
     <br>
     <p>The example consists in two classes:</p>
     <dl>
         <dt><code>TextReverserService</code></dt>
         <dd>A JMS MessageListener which consumes text messages and sends replies containing the reversed text</dd>
         <dt><code>QueueRequestorExample</code></dt>
         <dd>A JMS Client which uses a QueueRequestor to send text requests to a queue and receive replies with the reversed text</dd>
    </dl>
         
         
     <h2>Example step-by-step</h2>
     <p><i>To run the example, simply type <code>ant</code> from this directory</i></p>
     <br>
     <ol>
        <li>First we need to get an initial context so we can look-up the JMS connection factory from JNDI. This initial context will get it's properties from the <code>client-jndi.properties</code> file in the directory <code>../common/config</code></li>
        <pre>
           <code>InitialContext initialContext = getContext();</code>
        </pre>

        <li>We look up the JMS queue from JNDI</li>
        <pre>
           <code>Queue queue = (Queue)initialContext.lookup("/queue/exampleQueue");</code>
        </pre>

        <li>We look up JMS queue connection factory from JNDI</li>
        <pre>
           <code>QueueConnectionFactory cf = (QueueConnectionFactory)initialContext.lookup("/ConnectionFactory");</code>
        </pre>

        <li>We create the TextReverserService which will consume messages from the queue</li>
        <pre>
           <code> TextReverserService reverserService = new TextReverserService(cf, queue);</code>
        </pre>
        
        <li>We Create a JMS queue connection</li>
        <pre>
           <code>connection = cf.createQueueConnection();</code>
        </pre>
         
        <li>We start the connection. In order for delivery to occur on any consumers or subscribers on a connection, the connection must be started</li>
        <pre>
           <code>connection.start();</code>
        </pre>
         
        <li>We create a JMS queue session. The session is created as non transacted and will auto acknowledge messages (this is mandatory to use it to create a QueueRequestor)</li>
        <pre>
           <code>QueueSession session = connection.createQueueSession(false, Session.AUTO_ACKNOWLEDGE);</code>
        </pre>
        
        <li>We create a JMS QueueRequestor using the session and the queue</li>
        <pre>
           <code>QueueRequestor queueRequestor = new QueueRequestor(session, queue);</code>
        </pre>

        <li>We create a JMS text message to send as a request</li>
        <pre>
           <code>TextMessage request = session.createTextMessage("Hello, World!");</code>
        </pre>
   
        <li>We use the queue requestor to send the request and block until a reply is received</li>
        <pre>
           <code>TextMessage reply = (TextMessage)queueRequestor.request(request);</code>
        </pre>

        <li>The reply's text contains the reverse of the request's text</li>
        <pre>
           <code>System.out.println("Send request: " + request.getText());
           System.out.println("Received reply:" + reply.getText());</code>
        </pre>

        <li>We close the queue requestor to release its JMS resources</li>
        <pre>
           <code>queueRequestor.close()</code>
        </pre>

        <li>We do the same for the text reverser service</li>
        <pre>
           <code>reverserService.close()</code>
        </pre>

	<li>and finally <b>always</b> remember to close your JMS connections after use, in a <code>finally</code> block. Closing a JMS connection will automatically close all of its session, consumer, producer and browser objects</li>

        <pre>
           <code>

      finally
      {
         if (connection != null)
         {
            // Be sure to close our JMS resources!
            connection.close();
         }
      }
           </code>
        </pre>


         
     </ol>
  </body>
</html>