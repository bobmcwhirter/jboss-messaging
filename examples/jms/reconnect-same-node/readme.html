<html>
  <head>
    <title>JBoss Messaging JMS Automatic Reconnect Same Server Example</title>
    <link rel="stylesheet" type="text/css" href="../common/common.css">
  </head>
  <body>
     <h1>JBoss Messaging JMS Reconnect Same Server Example</h1>
     <br>
     <p>This example demonstrates how JBoss Messaging connections can be configured to be resilient to
     temporary network failures.</p>
     <p>In the case of a network failure being detected, either as a result of a failure to read/write to the connection,
     or the failure of a pong to arrive back from the server in good time after a ping is sent, instead of
     failing the connection immediately and notifying any user ExceptionListener objects, JBoss Messaging
     can be configured to automatically retry the connection, and reconnect to the server when it becomes
     available again across the network.</p>
     <p>In the case that the server didn't actually crash, i.e. the network was temporarily unavailable, the client will
     be able to resume all its sessions and connections where it left off, 100% transparently.</p>
     <p>This is very similar to automatic failover, the difference being with automatic failover the reconnection
     is to a different server, but in this cases the reconnection is to the <b>same</b> server</p>
     <p>In the case that the server <b>did</b> crash and was restarted, on reconnection the server session
     clearly won't still exist, so the session will be unable to continue transparently, and any registered
     ExceptionListener will be called, to allow any application layer reconnect logic to be called.</p>
     <p>This example starts a single server, connects to it and performs some JMS operations. We then
     simulate failure of the network connection by temporarily stopping the network acceptor on the server.
     (This is done by sending management messages, but that is not central to the purpose of the example).</p>
     <p>We then wait a few seconds, then restart the acceptor. The client reconnects and the session resumes
     as if nothing happened.</p>
     <p>The JMS Connection Factory is configured to reconnect automatically by specifying the various reconnect
     related attributes in the <code>jbm-jms.xml</code> file.</p>  
             
     <p>For more details on how to configure this and for clustering in general
     please consult the JBoss Messaging user manual.</p>
          
     <br>
     <h2>Example step-by-step</h2>
     <p><i>To run the example, simply type <code>ant</code> from this directory</i></p>
     <br>
     <ol>
        <li>Create an initial context to perform the JNDI lookup.</li>
        <pre>
           <code>initialContext = getContext(0);</code>
        </pre>

        <li>Perform a lookup on the queue</li>
        <pre>
           <code>Queue queue = (Queue) initialContext.lookup("/queue/exampleQueue");</code>
        </pre>

        <li>Perform a lookup on the Connection Factory</li>
        <pre>
           <code>ConnectionFactory cf = (ConnectionFactory)initialContext.lookup("/ConnectionFactory");</code>
        </pre>

        <li>We create a JMS connection</li>
        <pre>
           <code>connection = cf.createConnection();</code>
        </pre>

        <li>We create a JMS session. </li>
        <pre>
           <code>Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);</code>
        </pre>

        <li>We create a JMS message producer.</li>
        <pre>
          <code>MessageProducer messageProducer = session.createProducer(topic);</code>
       </pre>

        <li>We create a JMS text message that we are going to send.</li>
        <pre>
           <code>TextMessage message = session.createTextMessage("This is a text message");</code>
        </pre>

        <li>We send message to the queue</li>
        <pre>
           <code>messageProducer.send(message);</code>
        </pre>

        <li>We create a JMS Message Consumer to receive the message.</li>
          <pre>
           <code>MessageConsumer messageConsumer = session.createConsumer(queue);</code>
        </pre>

        <li>We start the connection. In order for delivery to occur on any consumers or subscribers on a connection, the connection must be started</li>
        <pre>
           <code>connection.start();</code>
        </pre>

        <li>To simulate a temporary problem on the network, we stop the remoting acceptor on the
         server which will casue all client connections to fail.</li>
        <pre>
           <code>stopAcceptor(initialContext);</code>
        </pre>
        
        <li>We wait 10 seconds, before restarting the acceptor. During this period the client will be retrying
        to connect. When the acceptor is restarted it will be successful in reconnecting.</li>
        
        <pre>
           <code>
            Thread.sleep(10000);

            startAcceptor(initialContext);
           </code>
        </pre>
        
        <li>We receive the message after reconnection! Note that no exceptions were received by the client.</li>
        
        <pre>
           <code>
           TextMessage messageReceived = (TextMessage)messageConsumer.receive(5000);
           </code>
        </pre>

        <li>And finally, <b>always</b> remember to close your JMS connections and resources after use, in a <code>finally</code> block. Closing a JMS connection will automatically close all of its sessions, consumers, producer and browser objects</li>

        <pre>
           <code>finally
           {
              if (initialContext != null)
              {
                initialContext.close();
              }
              if (connection != null)
              {
                 connection.close();
              }
           }</code>
        </pre>



     </ol>
  </body>
</html>