<html>
  <head>
    <title>JBoss Messaging JMS Security Example</title>
    <link rel="stylesheet" type="text/css" href="../common/common.css">
  </head>
  <body>
     <h1>JMS Security Example</h1>
     <br>
     <p>This example shows you how configure and use security with JBoss Messaging.</p>
     
     <p>With security properly configured, JBoss Messaging can restrict client access to its resouces, including 
     connection creation, message sending/receiving, etc. This is done by configuring users and roles as well as permissions in 
     the configuration files. </p>

     <p>JBoss Messaging supports wild-card in security configuration. This feature makes security configuration very much 
     flexible and it enables fine-grained control over permissions in an efficient way.</p>
     
     <p>For a full description of how to configure security with JBoss Messaging, please consult the user
     manual.</p>
     
     <p>This example demonstrates how to configure users/roles, how to configure topics with proper permissions using wild-card
     expressions, and how they take effects in a simple program. </p>
     
     <p>First we need to configure users with roles. Users and Roles are configured in <code>jbm-users.xml</code>. This example has four users
     configured as below </p>
     
     <pre>
     <code>
        &lt;user name=&quot;bill&quot; password=&quot;jbossmessaging&quot;&gt;
           &lt;role name=&quot;user&quot;/&gt;
        &lt;/user&gt;
  
        &lt;user name=&quot;andrew&quot; password=&quot;jbossmessaging1&quot;&gt;
           &lt;role name=&quot;europe-user&quot;/&gt;
        &lt;/user&gt;
   
        &lt;user name=&quot;frank&quot; password=&quot;jbossmessaging2&quot;&gt;
           &lt;role name=&quot;us-user&quot;/&gt;
           &lt;role name=&quot;news-user&quot;/&gt;
        &lt;/user&gt;
   
        &lt;user name=&quot;sam&quot; password=&quot;jbossmessaging3&quot;&gt;
           &lt;role name=&quot;news-user&quot;/&gt;
        &lt;/user&gt;
     </code>
     </pre>
     
     <p>
     Each user has three properties available: user name, password, and roles it belongs to. It should be noticed that
     a user can belong to more than one roles. In the above configuration, user 'bill' belongs to role 'user', user 'andrew'
     belongs to role 'europe-user', user 'frank' belongs to 'us-user' and 'news-user', and user 'sam' belongs to 'news-user'.
     </p>
     <p>
     User name and password consists of a valid account that can be used to establish connections to a JBoss Messaging server, while 
     roles are used in controling the access privileges against JBoss Messaging topics and queues. You can achieve this control by
     configuring proper permissions in <code>jbm-queues.xml</code>, like in the following
     </p>
     <pre><code>
	   &lt;!-- any user can have full control of generic topics --&gt;
	   &lt;security match=&quot;jms.topic.#&quot;&gt;
	      &lt;permission type=&quot;createDurableQueue&quot; roles=&quot;#&quot;/&gt;
	      &lt;permission type=&quot;deleteDurableQueue&quot; roles=&quot;#&quot;/&gt;
	      &lt;permission type=&quot;createTempQueue&quot; roles=&quot;#&quot;/&gt;
	      &lt;permission type=&quot;deleteTempQueue&quot; roles=&quot;#&quot;/&gt;
	      &lt;permission type=&quot;consume&quot; roles=&quot;#&quot;/&gt;
	      &lt;permission type=&quot;send&quot; roles=&quot;#&quot;/&gt;
	   &lt;/security&gt;
	
	   &lt;!-- only news-user can subscribe to news topic --&gt;
	   &lt;security match=&quot;jms.topic.news.#&quot;&gt;
	      &lt;permission type=&quot;consume&quot; roles=&quot;news-user&quot;/&gt;
	   &lt;/security&gt;
	
	   &lt;!-- only europe-user can create/delete any news.europe topics and pulish news to it. --&gt;
	   &lt;security match=&quot;jms.topic.news.europe.#&quot;&gt;
	      &lt;permission type=&quot;createDurableQueue&quot; roles=&quot;europe-user&quot;/&gt;
	      &lt;permission type=&quot;deleteDurableQueue&quot; roles=&quot;europe-user&quot;/&gt;
	      &lt;permission type=&quot;createTempQueue&quot; roles=&quot;europe-user&quot;/&gt;
	      &lt;permission type=&quot;deleteTempQueue&quot; roles=&quot;europe-user&quot;/&gt;
	      &lt;permission type=&quot;send&quot; roles=&quot;europe-user&quot;/&gt;
	   &lt;/security&gt;
	
	   &lt;!-- only us-user can create/delete any news.us topics and pulish news to it. --&gt;
	   &lt;security match=&quot;jms.topic.news.us.#&quot;&gt;
	      &lt;permission type=&quot;createDurableQueue&quot; roles=&quot;us-user&quot;/&gt;
	      &lt;permission type=&quot;deleteDurableQueue&quot; roles=&quot;us-user&quot;/&gt;
	      &lt;permission type=&quot;createTempQueue&quot; roles=&quot;us-user&quot;/&gt;
	      &lt;permission type=&quot;deleteTempQueue&quot; roles=&quot;us-user&quot;/&gt;
	      &lt;permission type=&quot;send&quot; roles=&quot;us-user&quot;/&gt;
	   &lt;/security&gt;
     </code></pre>
     
     <p>Permissions can be defined on any group of queues, by using a wildcard. You can easily specify 
     wildcards to apply certain permissions to a set of matching queues and topics. In the above configuration
     we have created four sets of permissions, each set matches against a special group of targets, indicated by wild-card match attributes.</p>
     
     <p>You can provide a very loose permission control for a very general group of destinations. Then you add more strict control
     over specific topics. By the above we define the following access rules:</p>
     
         <li>Only role 'us-user' can create/delete and pulish messages to topics whose names match wild-card pattern 'news.us.#'.</li>
         <li>Only role 'europe-user' can create/delete and publish messages to topics whose names match wild-card pattern 'news.europe'.</li>
         <li>Only role 'news-user' can subscribe messages to topics whose names match wild-card pattern 'news.#'. These enables users of 'news-user' can subscribe both news.us and news.europe topics.</li>
         <li>For any other topics that don't match any of the above wild-card patterns, all permissions are granted to any users.</li>
         
     <p>To illustrate the effect of permissions, three topics are deployed. Topic 'genericTopic' matches 'jms.topic.#' wild-card, topic 'news.europe.europeTopic' matches 'jms.topic.news.#' and
     jms.topic.news.europe.#' wild-cards, and topic 'news.us.usTopic' matches 'jms.topic.news.#' as well as 'jms.topic.news.us.#'.</p>
     
     <p>With JBoss Messaging, the security manager is also configurable. You can use JAASSecurityManager or JBossASSecurityManager based on you need. Please
     check out the jbm-standalone-beans.xml for how to do. In this example we just use the basic JBMSecurityManagerImpl which reads users/roles/passwords from the xml
     file <code>jbm-users.xml</code>.

     <br>
     <h2>Example step-by-step</h2>
     <p><i>To run the example, simply type <code>ant</code> from this directory</i></p>
     <br>
     <ol>
        <li>First we need to get an initial context so we can look-up the JMS connection factory and destination objects from JNDI. This initial context will get it's properties from the <code>client-jndi.properties</code> file in the directory <code>../common/config</code></li>
        <pre>
           <code>InitialContext initialContext = getContext(0);</code>
        </pre>

        <li>We look-up the JMS topic object from JNDI</li>
        <pre>
           <code>Topic topic = (Topic) initialContext.lookup("/topic/exampleTopic");</code>
        </pre>

        <li>We look-up the JMS connection factory object from JNDI</li>
        <pre>
           <code>ConnectionFactory cf = (ConnectionFactory) initialContext.lookup("/ConnectionFactory");</code>
        </pre>

        <li>We try to create a JMS Connection without user/password. It will fail.</li>
        <pre>
           <code>
         try
         {
            connection1 = cf.createConnection();
            result = false;
         }
         catch (JMSSecurityException e)
         {
            System.out.println("Error creating connection, detail: " + e.getMessage());
         }
           </code>
        </pre>

        <li>We create a Connection using wrong password, it will fail again.</li>
        <pre>
           <code>
         try
         {
            connection1 = cf.createConnection("jbm-sender", "wrong-password");
            result = false;
         }
         catch (JMSSecurityException e)
         {
            System.out.println("Error creating connection, detail: " + e.getMessage());
         }
           </code>
        </pre>

        <li>We now create two connections with correct credentials. connection1 is used for sending, and connection2 receiving.</li>
        <pre>
          <code>
         connection1 = cf.createConnection("jbm-sender", "jbossmessaging1");
         connection2 = cf.createConnection("jbm-consumer", "jbossmessaging2");
          </code>
       </pre>

        <li>We create 2 JMS Sessions.</li>
         <pre>
           <code>
         Session session1 = connection1.createSession(false, Session.AUTO_ACKNOWLEDGE);
         Session session2 = connection2.createSession(false, Session.AUTO_ACKNOWLEDGE);
           </code>
         </pre>

        <li>We create 2 Message Producers, where producer2 has no right to send.</li>
        <pre>
          <code>
         MessageProducer producer1 = session1.createProducer(topic);
         MessageProducer producer2 = session2.createProducer(topic);
          </code>
        </pre>

        <li>We create 2 JMS Message Consumers.</li>
        <pre>
           <code>
         MessageConsumer messageConsumer1 = session2.createConsumer(topic);
         MessageConsumer messageConsumer2 = session2.createConsumer(topic);
           </code>
        </pre>

        <li>We start the connections</li>
        <pre>
           <code>
         connection1.start();
         connection2.start();
           </code>
        </pre>

        <li>We create a Text Message</li>
        <pre>
           <code>TextMessage message = session1.createTextMessage("This is a text message");</code>
        </pre>

        <li>We send the message by producer2</li>
        <pre>
           <code>
         producer2.send(message);
         System.out.println("Producer2 sent message: " + message.getText());
           </code>
        </pre>

        <li>We check no messages are received by either consumer.</li>
        <pre>
           <code>
         TextMessage messageReceived1 = (TextMessage) messageConsumer1.receive(2000);
         TextMessage messageReceived2 = (TextMessage) messageConsumer2.receive(2000);
         if (messageReceived1 != null) 
         {
            System.out.println("Message received! " + messageReceived1.getText());
            result = false;
         }
         if (messageReceived2 != null) 
         {
            System.out.println("Message received! " + messageReceived2.getText());
            result = false;
         }
           </code>
        </pre>

        <li>We send the message by producer1.</li>
        <pre>
           <code>producer1.send(message);</code>
        </pre>

        <li>We receive the message.</li>
        <pre>
           <code>
         messageReceived1 = (TextMessage) messageConsumer1.receive(1000);
         messageReceived2 = (TextMessage) messageConsumer2.receive(1000);
         System.out.println("Consumer 1 Received message: " + messageReceived1.getText());
         System.out.println("Consumer 2 Received message: " + messageReceived2.getText());
           </code>
        </pre>
        
        <li>And finally, <b>always</b> remember to close your JMS connections and resources after use, in a <code>finally</code> block. Closing a JMS connection will automatically close all of its sessions, consumers, producer and browser objects</li>

        <pre>
           <code>finally
           {
              if (initialContext != null)
              {
                initialContext.close();
              }
              if (connection != null)
              {
                 connection.close();
              }
           }</code>
        </pre>



     </ol>
  </body>
</html>