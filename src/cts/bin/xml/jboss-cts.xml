<!--
     Ant script that applies modifications required to run JBoss Messaging TCK tests to
     a JBoss/CTS installation. Replace $TS_HOME/bin/cts/jboss-cts.xml with this file.
     For details more details, refer to
     http://wiki.jboss.org/wiki/Wiki.jsp?page=JBossMessagingTCKInstallation
     $Id$
 -->
<project name="JBoss Messaging CTS Setup" default="setup-cts">

   <property name="jboss.home" value="to be defined by caller"/>
   <property name="ts.home" value="to be defined by caller"/>

   <target name="setup-cts" description="Create a JBoss Messaging configuration">

      <echo message="jboss.home   = ${jboss.home}"/>
      <echo message="ts.home      = ${ts.home}"/>

      <property environment="ENV"/>

      <fail message="JBOSS_MESSAGE_HOME must be set!" unless="ENV.JBOSS_MESSAGING_HOME"/>

      <mkdir dir="${jboss.home}/server/cts-messaging"/>

      <copy todir="${jboss.home}/server/cts-messaging" overwrite="true">
         <fileset dir="${jboss.home}/server/default">
            <exclude name="data/**"/>
            <exclude name="log/**"/>
            <exclude name="tmp/**"/>
            <exclude name="work/**"/>
            <exclude name="deploy/jms/**"/>
            <exclude name="deploy/jbossws.sar/**"/>
            <exclude name="lib/jboss-messaging.jar"/>
         </fileset>
      </copy>

      <copy todir="${jboss.home}/server/cts-messaging/deploy"
            file="${jboss.home}/server/default/deploy/jms/jms-ra.rar"/>

      <!-- TODO pull this from repository -->
      <copy todir="${jboss.home}/server/cts-messaging/lib"
            file="${ENV.JBOSS_MESSAGING_HOME}/src/resources/jboss-remoting.jar" overwrite="true">
      </copy>

      <!-- TODO pull this from repository -->
      <copy todir="${jboss.home}/server/cts-messaging/lib"
            file="${ENV.JBOSS_MESSAGING_HOME}/src/resources/jboss-serialization.jar" overwrite="true">
      </copy>

      <!-- setup security -->
      <copy todir="${jboss.home}/server/cts-messaging/conf/props" overwrite="true">
         <fileset dir="${ENV.JBOSS_MESSAGING_HOME}/src/cts/conf">
            <include name="messaging-roles.properties"/>
            <include name="messaging-users.properties"/>
         </fileset>
      </copy>

      <!-- add the 'messaging' security domain -->
      <!-- TODO: I am sure this can be done better -->
      <replaceregexp file="${jboss.home}/server/cts-messaging/conf/login-config.xml" flags="s">
         <regexp pattern="(\x3capplication-policy name=\x22other\x22.*\x3c/application-policy\x3e)"/>
         <substitution expression="
         &lt;application-policy name=&quot;messaging&quot;&gt;
             &lt;authentication&gt;
                &lt;login-module code=&quot;org.jboss.security.auth.spi.UsersRolesLoginModule&quot;
                flag=&quot;required&quot;&gt;
                &lt;module-option name=&quot;usersProperties&quot;&gt;props/messaging-users.properties&lt;/module-option&gt;
                &lt;module-option name=&quot;rolesProperties&quot;&gt;props/messaging-roles.properties&lt;/module-option&gt;
                &lt;module-option name=&quot;unauthenticatedIdentity&quot;&gt;guest&lt;/module-option&gt;
                &lt;/login-module&gt;
             &lt;/authentication&gt;
         &lt;/application-policy&gt;
         \1"/>
      </replaceregexp>

      <!-- add the extra connection factories -->
      <copy todir="${jboss.home}/server/cts-messaging/deploy"
         file="${ENV.JBOSS_MESSAGING_HOME}/src/cts/deploy/tck-connection-factories-service.xml"/>

      <!-- activate the binding manager -->
      <replaceregexp file="${jboss.home}/server/cts-messaging/conf/jboss-service.xml" flags="s">
         <regexp pattern="(\x3cmbean code=\x22org.jboss.services.binding.ServiceBindingManager\x22.*org.jboss.services.binding.XMLServicesStoreFactory[ \t\n\r]*\x3c/attribute\x3e[ \t\n\r]*\x3c/mbean\x3e)"/>
         <substitution expression="--&gt;\1&lt;!--"/>
      </replaceregexp>

      <!-- Include the cts specific items -->
      <copy todir="${jboss.home}/server/cts-messaging/deploy" overwrite="true">
         <fileset dir="${ts.home}/jboss/deploy">
            <include name="pointbase-ds.xml"/>
            <include name="ROOT.war/**"/>
         </fileset>
         <filterset>
            <filter token="pointbase.driver" value="${pointbase.driver}"/>
            <filter token="pointbase.server" value="${pointbase.server}"/>
            <filter token="pointbase.port" value="${pointbase.port}"/>
            <filter token="pointbase.dbName" value="${pointbase.dbName}"/>
            <filter token="pointbase.user" value="${pointbase.user}"/>
            <filter token="pointbase.passwd" value="${pointbase.passwd}"/>
            <filter token="xa.xadatasource.class" value="${xa.xadatasource.class}"/>
         </filterset>
      </copy>

      <echo message="Copying extra libraries from TS_HOME/lib"/>
      <copy todir="${j2ee.home}/server/cts-messaging/lib" overwrite="true">
         <fileset dir="${ts.home}/lib">
            <include name="cts.jar"/>
            <include name="javatest.jar"/>
            <include name="tsharness.jar"/>
            <include name="tsprovider.jar"/>
         </fileset>
      </copy>

      <copy todir="${j2ee.home}/server/cts-messaging/lib" overwrite="true">
         <fileset dir="${ts.home}/jboss/lib">
            <include name="jboss-porting.jar"/>
         </fileset>
      </copy>
   </target>

   <target name="clean-cts" description="Removes the JBoss Messaging CTS configuration from JBOSS_HOME/server/cts-messaging">
      <delete dir="${jboss.home}/server/cts-messaging"/>
   </target>

   <target name="restart.server">
      <echo message="do nothing"/>
   </target>

</project>
