<?xml version="1.0" encoding="UTF-8"?>

<deployment xmlns="urn:jboss:bean-deployer:2.0">

   <bean name="Configuration" class="org.jboss.messaging.core.FileConfiguration"/>

   <bean name="ServiceLocator" class="org.jboss.messaging.microcontainer.ServiceLocator">
      <demand>jboss.jca:name=DefaultDS,service=DataSourceBinding</demand>
      <!--<depends>jboss:service=TransactionManager</depends>-->
      <!-- <depends>jboss.jca:service=DataSourceBinding,name=DefaultDS</depends>-->
   </bean>

   <bean name="MessagingServerManagement" class="org.jboss.messaging.core.impl.server.MessagingServerManagementImpl">
      <property name="messagingServer">
         <inject bean="MessagingServer"/>
      </property>
   </bean>

   <bean name="MessagingServer" class="org.jboss.messaging.core.impl.server.MessagingServerImpl">
      <property name="persistenceManager">
         <inject bean="PersistenceManager"/>
      </property>
      <property name="jmsUserManager">
         <inject bean="JMSUserManager"/>
      </property>
      <property name="remotingService">
         <inject bean="RemotingService"/>
      </property> 
      <property name="configuration">
         <inject bean="Configuration"/>
      </property>
      <property name="authenticationManager">
         <inject bean="ServiceLocator" property="authenticationManager"/>
      </property>
   </bean>

   <bean name="PersistenceManager" class="org.jboss.messaging.core.impl.bdbje.BDBJEPersistenceManager">
   
      <property name="largeMessageRepository">${user.home}/bdbje/large</property>
      
      <property name="minLargeMessageSize">1000000</property>
      
      <property name="environment">
         <inject bean="BDBJEEnvironment"/>
      </property>
            
   </bean>
   
   
   
   <bean name="BDBJEEnvironment" class="org.jboss.messaging.core.impl.bdbje.integration.RealBDBJEEnvironment">
   
      <property name="environmentPath">${user.home}/bdbje/env</property>
      
      <property name="createEnvironment">true</property>
      
      <property name="syncVM">true</property>
      
      <property name="syncOS">false</property>
   
      <property name="memoryCacheSize">-1</property>
            
   </bean>
   

   <bean name="JMSUserManager" class="org.jboss.jms.server.plugin.JDBCJMSUserManager">
      <property name="createTablesOnStartup">true</property>
      <property name="ds">
         <inject bean="ServiceLocator" property="dataSource"/>
      </property>
      <property name="tm">
         <inject bean="ServiceLocator" property="transactionManager"/>
      </property>
      <property name="sqlProperties">
         <map class="java.util.Properties" keyClass="java.lang.String" valueClass="java.lang.String">
            <entry>
               <key>POPULATE.TABLES.1</key>
               <value>INSERT INTO JBM_USER (USER_ID,PASSWD,CLIENTID) VALUES ('dilbert','dogbert','dilbert-id')
               </value>
            </entry>
            <entry>
               <key>POPULATE.TABLES.2</key>
               <value>INSERT INTO JBM_USER (USER_ID,PASSWD,CLIENTID) VALUES ('guest','guest')
               </value>
            </entry>
            <entry>
               <key>POPULATE.TABLES.3</key>
               <value>INSERT INTO JBM_ROLE (ROLE_ID, USER_ID) VALUES ('guest','guest')
               </value>
            </entry>
         </map>
      </property>
   </bean>
   
   <bean name="RemotingService" class="org.jboss.messaging.core.remoting.impl.mina.MinaService">
      <constructor>
         <parameter>
            <inject bean="Configuration" property="remotingConfiguration"/>
         </parameter>
      </constructor>
   </bean> 
   
   <bean name="JNDIObjectDeployer" class="org.jboss.jms.jndi.JNDIObjectDeployer">
      <property name="messagingServer">
         <inject bean="MessagingServer"/>
      </property>
   </bean>
 
</deployment>