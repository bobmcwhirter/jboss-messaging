#!/bin/sh
#
# bash script for running a single unit test case.
#
# It expects TARGET_CLASS and TARGET_TEST to be set. If they are not, it tries to load them
# from ./.testrc.
#
# Options:
#    -debug start the client VM in debugging mode
#    -remote set the "remote" system property so the server start in a remote VM
#    -remotedebug starts the VM that runs the remote server in debugging mode. The remote VM
#            will attempt to connect to the debugger, which should be lisening on 'rmiserver'
#
#


reldir=`dirname $0`

if [ -z "$TARGET_CLASS" -a -f $reldir/.testrc ]; then
   . $reldir/.testrc
fi

if [ -z "$TARGET_CLASS" ]; then
   echo "No TARGET_CLASS found! Set the TARGET_CLASS environment variable and try again." 1>&2
   exit 1
fi

outputdir="$reldir/../output"

if ! mkdir -p $outputdir/logs; then
   echo "failed to create $outputdir/logs"
fi

# reset the log files as by default log4j is configure to append
rm -f $outputdir/logs/*.log

cygwin=false;
case "`uname`" in
    CYGWIN*)
        cygwin=true
        ;;
esac

if [ $cygwin = true ]; then
    SEP=";"
else
    SEP=":"
fi

#for i in `ls $JBOSS_HOME/client/*.jar`; do
#	JBOSS_CLASSPATH=$i${SEP}$JBOSS_CLASSPATH
#done

while [ "$1" != "" ]; do
    if [ "$1" = "-debug" ]; then
        if [ $cygwin = false ]; then
            JAVA_OPTS="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=12348"
        else
            JAVA_OPTS="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=unittest"
            #Eclipse doesn't support remote debugging with shared memory afaik
            #JAVA_OPTS="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=12348"
        fi
    fi
    if [ "$1" = "-remote" ]; then
        isRemote=true;
        REMOTE_TEST="-Dremote=true"
    fi
    if [ "$1" = "-remotedebug" ]; then
        REMOTE_DEBUG_FLAG="-debug"
    fi
    shift
done

JAVA_OPTS="$JAVA_OPTS -Dmodule.output=$reldir/../output $REMOTE_TEST"

REMOTING_LIB=$reldir/../../../thirdparty/jboss/remoting/lib/jboss-remoting.jar
#REMOTING_LIB=$reldir/../resources/jboss-remoting.jar

JGROUPS_LIB=$reldir/../../../thirdparty/jgroups/lib/jgroups.jar
#JGROUPS_LIB=$reldir/../resources/jgroups-core.jar


if [ "$TARGET_TEST" != "" ]; then
   TARGET_TEST="-t $TARGET_TEST"
fi

if [ "$isRemote" = "true" ]; then
  $reldir/start-rmi-server $REMOTE_DEBUG_FLAG
fi


java $JAVA_OPTS -cp \
$reldir/../etc${SEP}\
$reldir/../../src/etc${SEP}\
$reldir/../output/classes${SEP}\
$reldir/../../output/classes${SEP}\
$reldir/../../../thirdparty/jboss/serialization/lib/jboss-serialization.jar${SEP}\
$reldir/../../../thirdparty/apache-log4j/lib/log4j.jar${SEP}\
$reldir/../../../thirdparty/apache-logging/lib/commons-logging.jar${SEP}\
$reldir/../../../thirdparty/junit/lib/junit.jar${SEP}\
$reldir/../../../thirdparty/oswego-concurrent/lib/concurrent.jar${SEP}\
$reldir/../../../thirdparty/javassist/lib/javassist.jar${SEP}\
$reldir/../../../thirdparty/trove/lib/trove.jar${SEP}\
$reldir/../../../thirdparty/apache-httpclient/lib/commons-httpclient.jar${SEP}\
$reldir/../../../thirdparty/dom4j/lib/dom4j.jar${SEP}\
$reldir/../../../thirdparty/sun-servlet/lib/servlet-api.jar${SEP}\
$reldir/../../src/resources/hsqldb.jar${SEP}\
${REMOTING_LIB}${SEP}\
$reldir/../../../j2ee/output/lib/jboss-j2ee.jar${SEP}\
$reldir/../../../j2se/output/lib/jboss-j2se.jar${SEP}\
$reldir/../../../jmx/output/lib/jboss-jmx.jar${SEP}\
$reldir/../../../mbeans/output/lib/jboss-mbeans.jar${SEP}\
$reldir/../../../aop/output/lib/jboss-aop.jar${SEP}\
$reldir/../../../common/output/lib/jboss-common.jar${SEP}\
$reldir/../../../system/output/lib/jboss-system.jar${SEP}\
$reldir/../../../transaction/output/lib/jboss-transaction.jar${SEP}\
$reldir/../../../security/output/lib/jbosssx.jar${SEP}\
$reldir/../../../connector/output/lib/jboss-local-jdbc.jar${SEP}\
$reldir/../../../connector/output/lib/jboss-common-jdbc-wrapper.jar${SEP}\
$reldir/../../../connector/output/lib/jboss-jca.jar${SEP}\
$reldir/../../../server/output/lib/jboss.jar${SEP}\
${JGROUPS_LIB}${SEP}\
 org.jboss.test.messaging.tools.junit.SelectiveTestRunner $TARGET_CLASS $TARGET_TEST


if [ "$isRemote" = "true" ]; then
  $reldir/stop-rmi-server
fi

