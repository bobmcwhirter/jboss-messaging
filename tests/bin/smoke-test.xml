<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id$ -->

<project default="smoke-test" name="Messaging Smoke Test">

   <property environment="ENV"/>
   <property name="sleep.interval" value="60"/>

   <target name="validate-messaging-sar">

      <available property="messaging-sar"
         type="file" file="../../output/lib/jboss-messaging-scoped.sar"/>
      <fail unless="messaging-sar"
         message="../../output/lib/jboss-messaging-scoped.sar does not exist! Build it and try again"/>
   </target>

   <target name="validate-jboss-instance">

      <fail unless="ENV.JBOSS_HOME"
         message="JBOSS_HOME environment variable not set! Set it and try again"/>
      <available property="jboss-messaging-configuration"
         type="dir" file="${ENV.JBOSS_HOME}/server/messaging-smoke-test"/>
      <fail if="jboss-messaging-configuration"
         message="'messaging-smoke-test' configuration already exists. Delete it manually and try again"/>
   </target>

   <target name="create-messaging-configuration">

      <mkdir dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test"/>
      <copy todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test">
         <fileset dir="${ENV.JBOSS_HOME}/server/default"/>
      </copy>
      <copy file="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy/jms/jms-ra.rar"
         todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/data" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/log" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/tmp" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/work" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy/jms"/>
      <!-- add unauthenticated identity to "other" -->
      <replaceregexp file="${ENV.JBOSS_HOME}/server/messaging-smoke-test/conf/login-config.xml" flags="s">
         <regexp pattern="(\x3capplication-policy[ \t\n\r]+name[ \t\n\r]*=[ \t\n\r]*\x22other\x22.+flag[ \t\n\r]*=[ \t\n\r]*\x22required\x22)[ \t\n\r]*/\x3e"/>
         <substitution expression="\1>&lt;module-option name=&quot;unauthenticatedIdentity&quot;&gt;guest&lt;/module-option&gt;&lt;/login-module&gt;"/>
      </replaceregexp>
   </target>

   <target name="deploy-sar">
      <copy file="../../output/lib/jboss-messaging-scoped.sar"
         todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy"/>
   </target>

  <target name="start-jboss">
      <java classname="org.jboss.Main" fork="yes" spawn="yes" dir="${ENV.JBOSS_HOME}/bin">
         <jvmarg value="-server"/>
         <jvmarg value="-Xms128m"/>
         <jvmarg value="-Xmx128m"/>
         <arg value="-c"/>
         <arg value="messaging-smoke-test"/>
         <sysproperty key="java.endorsed.dirs" value="${ENV.JBOSS_HOME}/lib/endorsed"/>
         <classpath>
            <pathelement location="${ENV.JBOSS_HOME}/bin/run.jar"/>
            <pathelement location="${java.home}/lib/tools.jar"/>
         </classpath>
      </java>
   </target>

   <target name="shutdown-jboss">
      <java classname="org.jboss.Shutdown" fork="yes" dir="${ENV.JBOSS_HOME}/bin">
         <jvmarg value="-server"/>
         <jvmarg value="-Xms128m"/>
         <jvmarg value="-Xmx128m"/>
         <arg value="-S"/>
         <classpath>
            <pathelement location="${ENV.JBOSS_HOME}/bin/shutdown.jar"/>
            <pathelement location="${ENV.JBOSS_HOME}/client\jbossall-client.jar"/>
         </classpath>
      </java>
   </target>

   <!-- allow the server time to start/shut down -->
   <target name="sleep">
      <echo message="Sleeping for ${sleep.interval} seconds ..."/>
      <sleep seconds="${sleep.interval}"/>
   </target>

   <target name="invoke">
       <java classname="org.jboss.console.twiddle.Twiddle"
          fork="yes"
          failonerror="yes"
          dir="${ENV.JBOSS_HOME}/bin">
          <jvmarg value="-server"/>
          <jvmarg value="-Xms128m"/>
          <jvmarg value="-Xmx128m"/>
          <arg line="get jboss.messaging:service=ServerPeer serverPeerID"/>
          <sysproperty key="java.endorsed.dirs" value="${ENV.JBOSS_HOME}/lib/endorsed"/>
          <classpath>
             <pathelement location="${ENV.JBOSS_HOME}/bin/twiddle.jar"/>
             <pathelement location="${ENV.JBOSS_HOME}/client/jbossall-client.jar"/>
             <pathelement location="${ENV.JBOSS_HOME}/client/getopt.jar"/>
             <pathelement location="${ENV.JBOSS_HOME}/client/log4j.jar"/>
             <pathelement location="${ENV.JBOSS_HOME}/lib/jboss-jmx.jar"/>
             <pathelement location="${ENV.JBOSS_HOME}/lib/dom4j.jar"/>
          </classpath>
       </java>
    </target>

   <target name="smoke-test"
      depends="validate-messaging-sar,
               validate-jboss-instance,
               create-messaging-configuration,
               deploy-sar,
               start-jboss,
               sleep,
               invoke"/>

   <target name="clean">
       <antcall target="shutdown-jboss"/>
       <antcall target="sleep"/>
       <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test" quiet="yes"/>
   </target>

</project>

