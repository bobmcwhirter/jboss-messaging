<?xml version="1.0" encoding="UTF-8"?>

<!-- =========================================================================================== -->
<!--                                                                                             -->
<!-- JBoss, Home of Professional Open Source                                                     -->
<!-- Copyright 2005, JBoss Inc., and individual contributors as indicated                        -->
<!-- by the @authors tag. See the copyright.txt in the distribution for a                        -->
<!-- full listing of individual contributors.                                                    -->
<!--                                                                                             -->
<!-- This is free software; you can redistribute it and/or modify it                             -->
<!-- under the terms of the GNU Lesser General Public License as                                 -->
<!-- published by the Free Software Foundation; either version 2.1 of                            -->
<!-- the License, or (at your option) any later version.                                         -->
<!--                                                                                             -->
<!-- This software is distributed in the hope that it will be useful,                            -->
<!-- but WITHOUT ANY WARRANTY; without even the implied warranty of                              -->
<!-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU                            -->
<!-- Lesser General Public License for more details.                                             -->
<!--                                                                                             -->
<!-- You should have received a copy of the GNU Lesser General Public                            -->
<!-- License along with this software; if not, write to the Free                                 -->
<!-- Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA                          -->
<!-- 02110-1301 USA, or see the FSF site: http://www.fsf.org.                                    -->
<!--                                                                                             -->
<!-- =========================================================================================== -->


<!-- =========================================================================================== -->
<!--                                                                                             -->
<!-- $Id$ -->
<!--                                                                                             -->
<!-- =========================================================================================== -->

<project default="tests" name="JBoss Messaging Tests">

   <!--
        'tests' is Messaging's subproject, we're relying on the main project thirdparty and lib
        directories.
   -->
   <property name="project.root" value="${basedir}/.."/>

   <!--
        Import Messaging's properties, paths and everything else.
   -->
   <import file="../build-messaging.xml"/>

   <!-- ======================================================================================== -->
   <!-- Configuration                                                                            -->
   <!-- ======================================================================================== -->

   <property file="build.properties"/>

   <property name="build.tests.remote" value="false"/>
   <property name="test.bind.address" value="localhost"/>

   <!--
        Functional tests.
   -->

   <property name="functional.tests.database" value="hsqldb"/>
   <property name="functional.tests.serialization" value="jms"/>

   <!--
        Stress tests.
   -->

   <property name="stress.tests.database" value="mysql"/>
   <property name="stress.tests.serialization" value="jms"/>

   <!-- Clustering tests -->
   <property name="clustering.tests.database" value="mysql"/>
   <property name ="test-mask" value="*Test"/>

   <!--
        Default remoting configuration (must be overrided by tasks that need it set otherwise).
   -->
   <property name="test.remoting" value="socket"/>


   <!--
       By default, remote servers log file names should end in remote-server
   -->
   <property name="remote.server.test.logfile.suffix" value="remote-server"/>


   <!--
        Project paths.
   -->

   <property name="tests.root" value="${basedir}"/>
   <property name="source.tests.java" value="${tests.root}/src"/>
   <property name="source.tests.stylesheets" value="${source.tests.java}/stylesheets"/>
   <property name="tests.output" value="${tests.root}/output"/>
   <property name="build.tests.classes" value="${tests.output}/classes"/>
   <property name="build.tests.lib" value="${tests.output}/lib"/>
   <property name="build.tests.reports" value="${tests.output}/reports"/>
   <property name="build.tests.stylesheets" value="${tests.output}/stylesheets"/>
   <property name="build.tests.archive" value="jboss-messaging-tests.jar"/>
   <property name="build.tests.ejbarchive" value="jboss-messaging-tests-ejb.jar"/>

   <!--
        JUnit configuration (values specified in ./build.properties have priority)
   -->

   <property name="junit.printsummary" value="true"/>
   <property name="junit.haltonerror" value="false"/>
   <property name="junit.haltonfailure" value="false"/>
   <property name="junit.fork" value="true"/>
   <property name="junit.includeantruntime" value="true"/>
   <property name="junit.timeout" value="1200000"/>
   <property name="stress.timeout" value="4800000"/>

   <property name="junit.showoutput" value="true"/>
   <property name="junit.jvm" value=""/>
   <property name="junit.jvm.options" value=""/>
   <property name="junit.formatter.usefile" value="true"/>
   <property name="junit.batchtest.todir" value="${build.tests.reports}"/>
   <property name="junit.batchtest.haltonerror" value="false"/>
   <property name="junit.batchtest.haltonfailure" value="false"/>
   <property name="junit.batchtest.fork" value="true"/>
   <property name="junit.test.haltonfailure" value="false"/>
   <property name="junit.test.haltonerror" value="false"/>

   <!--
        Locally maintained dependencies.
   -->

   <path id="jboss.server.classpath">
      <pathelement location="${jboss.server.lib}/jboss.jar"/>
   </path>

   <property name="jboss.jca.lib" value="${tests.root}/lib"/>
   <path id="jboss.jca.classpath">
      <pathelement path="${jboss.jca.lib}/jboss-jca.jar"/>
      <pathelement path="${jboss.jca.lib}/jboss-local-jdbc.jar"/>
      <pathelement path="${jboss.jca.lib}/jboss-common-jdbc-wrapper.jar"/>
      <pathelement path="${jboss.jca.lib}/jms-ra.jar"/>
   </path>

   <property name="jboss.mbeans.lib" value="${tests.root}/lib"/>
   <path id="jboss.mbeans.classpath">
      <pathelement path="${jboss.mbeans.lib}/jboss-mbeans.jar"/>
   </path>

   <path id="jboss.naming.classpath">
      <pathelement path="${jboss.naming.lib}/jnp-client.jar"/>
   </path>

   <!--
       JDBC Drivers.
   -->
   <path id="any.jdbc.driver.classpath">
          <fileset dir="${tests.root}/lib/jdbc-drivers" includes="*.jar"/>
   </path>


   <path id="mysql.jdbc.driver.classpath">
      <pathelement path="${tests.root}/lib/mysql-connector-java-3.1.13-bin.jar"/>
   </path>

   <path id="oracle.jdbc.driver.classpath">
      <pathelement path="${tests.root}/lib/ojdbc14.jar"/>
   </path>

   <path id="postgres.jdbc.driver.classpath">
      <pathelement path="${tests.root}/postgresql-8.1-405.jdbc3.jar"/>
   </path>

   <!--
        The compilation classpath.
   -->

   <path id="test.compilation.classpath">
      <path refid="compilation.classpath"/>
      <path location="../output/lib/jboss-messaging.jar"/>
      <path refid="junit.junit.classpath"/>
      <path refid="any.jdbc.driver.classpath"/>
      <path refid="hsqldb.hsqldb.classpath"/>
      <path refid="jboss.server.classpath"/> <!-- for org.jboss.jms.jndi.JNDIProviderAdapter -->
      <path refid="jboss.jca.classpath"/>  <!-- for org.jboss.resource.adapter.jdbc.local.LocalManagedConnectionFactory, etc -->
      <path refid="jboss.profiler.jvmti.classpath"/>
   </path>

   <!--
        The execution classpath.
   -->

   <path id="test.execution.classpath">
      <pathelement location="${tests.root}/etc"/>
      <pathelement location="${build.tests.classes}"/>
      <pathelement location="${project.root}/src/etc"/> <!-- server's configuration files -->
      <pathelement location="${project.root}/src/etc/server/default/deploy"/>
      <path refid="test.compilation.classpath"/>
      <path refid="dom4j.dom4j.classpath"/>
      <path refid="apache.log4j.classpath"/>
      <path refid="apache.logging.classpath"/>
      <path refid="apache.xerces.classpath"/>
      <path refid="jboss.mbeans.classpath"/>
      <path refid="jboss.naming.classpath"/>
      <path refid="jboss.jbossxb.classpath"/>
      <path refid="jgroups.jgroups.classpath"/>
      <path refid="apache.logging.classpath"/>
      <path refid="mysql.jdbc.driver.classpath"/>
      <path refid="oracle.jdbc.driver.classpath"/>
      <path refid="postgres.jdbc.driver.classpath"/>
      <path refid="apache.tomcat.classpath"/>
      <path refid="apache.logging.classpath"/>
   </path>

   <path id="stress.test.execution.classpath">
      <pathelement path="${tests.root}/etc/stress"/>
      <path refid="test.execution.classpath"/>
   </path>

   <!-- ======================================================================================== -->
   <!-- Compilation Tasks                                                                        -->
   <!-- ======================================================================================== -->

   <target name="init" depends="resolve-local-dependencies"/>

   <target name="compile" depends="init">

      <mkdir dir="${build.tests.classes}"/>
      <javac destdir="${build.tests.classes}"
             optimize="${javac.optimize}"
             target="1.4"
             source="1.4"
             debug="${javac.debug}"
             depend="${javac.depend}"
             verbose="${javac.verbose}"
             deprecation="${javac.deprecation}"
             includeJavaRuntime="${javac.include.java.runtime}"
             failonerror="${javac.fail.onerror}">
         <src path="${source.tests.java}"/>
         <classpath refid="test.compilation.classpath"/>
         <include name="**/*.java"/>
      </javac>

      <!--
           RMI compilation to to create stub for server.
      -->
      <rmic base="${build.tests.classes}"
            includes="**/RMITestServer.class,**/RMINamingDelegate.class">
         <classpath refid="test.compilation.classpath"/>
      </rmic>
   </target>

   <!-- ======================================================================================== -->
   <!-- Archival Tasks                                                                           -->
   <!-- ======================================================================================== -->

   <target name="tests-jar" depends="compile">

      <mkdir dir="${build.tests.lib}"/>
      <jar jarfile="${build.tests.lib}/${build.tests.archive}">
         <fileset dir="${build.tests.classes}">
            <include name="org/jboss/test/messaging/**"/>
         </fileset>
      </jar>
   </target>

   <!-- ======================================================================================== -->
   <!-- Execution Helper Tasks                                                                   -->
   <!-- ======================================================================================== -->

   <target name="prepare-testdirs">
      <mkdir dir="${build.tests.reports}"/>
      <mkdir dir="${tests.output}/logs"/>
   </target>

   <target name="clear-test-logs" unless="test.logs.cleared">

      <!-- At the beginning of a test run, clean up the logs, since log4j runs in "append" mode -->
      <echo message="Cleaning test logs ${tests.output}/logs/*.log"/>
      <delete quiet="true">
         <fileset dir="${tests.output}/logs" includes="*.log"/>
      </delete>
      <property name="test.logs.cleared" value="true"/>
   </target>

   <target name="start-rmi-server" depends="init"
           description="Starts the RMI server used by remote tests">

      <java classname="org.jboss.test.messaging.tools.jmx.rmi.RMITestServer" fork="true" spawn="true">
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.logfile.suffix" value="${remote.server.test.logfile.suffix}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.remoting" value="${test.remoting}"/>
         <sysproperty key="java.net.preferIPv4Stack" value="true"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=rmiserver"/>
         -->
         <classpath refid="test.execution.classpath"/>
      </java>
   </target>

   <target name="start-rmi-server-clustering" depends="init"
           description="Starts the RMI server used by clustering tests">

      <java classname="org.jboss.test.messaging.tools.jmx.rmi.RMITestServer" fork="true" spawn="true">
         <sysproperty key="test.server.index" value="${test.server.index}"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.logfile.suffix" value="clustering-server${test.server.index}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${clustering.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.clustered" value="true"/>
         <sysproperty key="java.net.preferIPv4Stack" value="true"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=rmiserver"/>
         -->
         <classpath refid="test.execution.classpath"/>
      </java>
   </target>

   <target name="start-rmi-server-stress" depends="init"
           description="Starts the RMI server used by remote stress tests">

      <java classname="org.jboss.test.messaging.tools.jmx.rmi.RMITestServer" fork="true" spawn="true">
         <jvmarg value="-Xmx768M"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.logfile.suffix" value="remote-server-stress"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${stress.tests.database}"/>
         <sysproperty key="test.serialization" value="${stress.tests.serialization}"/>
         <sysproperty key="test.remoting" value="${test.remoting}"/>
         <!-- <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=rmiserver"/> -->
         <classpath refid="stress.test.execution.classpath"/>
      </java>
   </target>

   <target name="stop-rmi-server" depends="init"
           description="Stops the RMI server used by remote tests">
      <java classname="org.jboss.test.messaging.tools.jmx.rmi.StopRMIServer"
            classpathref="test.execution.classpath"/>
   </target>

   <target name="stop-rmi-server-clustering" depends="init"
           description="Stops the RMI server used by clustering tests">
      <java classname="org.jboss.test.messaging.tools.jmx.rmi.StopRMIServer"
            classpathref="test.execution.classpath">
         <sysproperty key="test.server.index" value="${test.server.index}"/>
      </java>
   </target>

   <!-- ======================================================================================== -->
   <!-- Test Execution Tasks                                                                     -->
   <!-- ======================================================================================== -->

   <target name="tests" depends="tests-jar, prepare-testdirs, clear-test-logs">
      <antcall target="crash-tests"/>
      <antcall target="invm-tests"/>
      <antcall target="remote-tests"/>  <!-- default remoting configuration (socket) -->

      <!--
      <antcall target="clustering-tests"/>
      <antcall target="remote-tests">
         <param name="test.remoting" value="http"/>
      </antcall>
      -->
   </target>

   <target name="http-tests" depends="tests-jar, prepare-testdirs, clear-test-logs">
      <antcall target="remote-tests">
         <param name="test.remoting" value="http"/>
      </antcall>
   </target>

   <target name="stress-tests" depends="tests-jar, prepare-testdirs, clear-test-logs">
      <antcall target="invm-stress-tests"/>
      <antcall target="remote-stress-tests"/> <!-- default remoting configuration (socket) -->
      <antcall target="remote-stress-tests">
         <param name="test.remoting" value="http"/>
      </antcall>
   </target>

   <target name="invm-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs all available tests an in-VM configuration">

      <echo message=""/>
      <echo message="Running invm tests, fork=${junit.fork}, junit.batchtest.fork=${junit.batchtest.fork}"/>
      <echo message=""/>

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">

         <sysproperty key="remote" value="false"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.logfile.suffix" value="invm"/>
         <sysproperty key="build.lib" value="${build.lib}"/>
         <jvmarg value="-Xmx512M"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=antjunit"/>
         -->
         <classpath refid="test.execution.classpath"/>
         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/*Test.class"/>
               <exclude name="**/messaging/core/ha/**/*Test.class"/>
               <exclude name="**/jms/stress/**"/>
               <exclude name="**/jms/crash/*Test.class"/>
               <exclude name="**/*LeakTest.class"/>
               <exclude name="**/jms/manual/**/*Test.class"/>
               <exclude name="**/jms/clustering/*Test.class"/>
               <exclude name="**/jms/RemotingConnectionConfigurationTest.class"/>
               <exclude name="**/thirdparty/remoting/ManualConnectionValidatorTest.class"/>
               <exclude name="**/thirdparty/remoting/PureAsynchronousCallTest.class"/>
               <exclude name="**/thirdparty/remoting/RemotingConnectionFailureTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="local-jms-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs all available tests an in-VM configuration">

      <echo message=""/>
      <echo message="Running invm tests, fork=${junit.fork}, junit.batchtest.fork=${junit.batchtest.fork}"/>
      <echo message=""/>

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">

         <sysproperty key="remote" value="false"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.logfile.suffix" value="invm"/>
         <sysproperty key="build.lib" value="${build.lib}"/>
         <jvmarg value="-Xmx512M"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=antjunit"/>
         -->
         <classpath refid="test.execution.classpath"/>
         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/messaging/jms/**/*Test.class"/>
               <exclude name="**/jms/stress/**"/>
               <exclude name="**/jms/crash/*Test.class"/>
               <exclude name="**/*LeakTest.class"/>
               <exclude name="**/jms/manual/**/*Test.class"/>
               <exclude name="**/jms/clustering/*Test.class"/>
               <exclude name="**/jms/RemotingConnectionConfigurationTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="ref-test" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs all available tests an in-VM configuration">

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">

         <sysproperty key="remote" value="false"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="build.lib" value="${build.lib}"/>
         <jvmarg value="-Xmx512M"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=antjunit"/>
         -->
         <classpath refid="test.execution.classpath"/>
         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/messaging/jms/ReferenceableTest.class"/>
               <exclude name="**/jms/stress/**"/>
               <exclude name="**/jms/crash/*Test.class"/>
               <exclude name="**/*LeakTest.class"/>
               <exclude name="**/jms/clustering/*Test.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="invm-stress-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs all stress tests in an in-VM configuration">

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${stress.timeout}">

         <sysproperty key="remote" value="false"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${stress.tests.database}"/>
         <sysproperty key="test.serialization" value="${stress.tests.serialization}"/>
         <sysproperty key="test.logfile.suffix" value="invm"/>
         <jvmarg value="-Xmx512M"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=antjunit"/>
         -->
         <classpath refid="stress.test.execution.classpath"/>
         <sysproperty key="messaging-test-configuration" value="StressInVM"/>
         <formatter classname="org.jboss.test.messaging.tools.ant.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}" extension="-StressInVM.xml"/>
         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/jms/stress/*Test.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="remote-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs remotely all tests for which it makes sense to run remotely">

      <antcall target="stop-rmi-server"/>
      <antcall target="start-rmi-server"/>

      <mkdir dir="${build.tests.reports}"/>

      <echo message=""/>
      <echo message="Running remote tests, fork=${junit.fork}, junit.batchtest.fork=${junit.batchtest.fork}, remoting=${test.remoting}"/>
      <echo message=""/>

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="yes"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">

         <sysproperty key="remote" value="true"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.remoting" value="${test.remoting}"/>
         <sysproperty key="test.logfile.suffix" value="remote-client"/>
         <jvmarg value="-Xmx512M"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=antjunit"/>
         -->
         <classpath>
            <path refid="test.execution.classpath"/>

            <!-- Add this when http://jira.jboss.org/jira/browse/JBAS-2554 is done -->
            <!--
            <path refid="jboss.test.classpath"/>
            -->
         </classpath>

         <!-- Use this when http://jira.jboss.org/jira/browse/JBAS-2554 is done -->
         <!--
         <sysproperty key="jboss-junit-configuration" value="Remote"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
            usefile="${junit.formatter.usefile}" extension="-Remote.xml"/>
         -->

         <sysproperty key="messaging-test-configuration" value="Remote-${test.remoting}"/>
         <formatter classname="org.jboss.test.messaging.tools.ant.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}" extension="-Remote-${test.remoting}.xml"/>

         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <!--
                 I needed a way to intercept the end of a forked ant JUnit test run, in order to
                 perform clean-up, and this is it: register a JUnitTestSuiteListener as a JUnit
                 batchtest formatter, and it will get notified on a endTestSuite() event.
            -->
            <formatter classname="org.jboss.test.messaging.tools.ant.JUnitTestSuiteListener"/>

            <fileset dir="${build.tests.classes}">
               <include name="**/jms/**/*Test.class"/>
               <include name="**/thirdparty/**/*Test.class"/>
               <exclude name="**/jms/stress/**"/>
               <exclude name="**/jms/server/**"/>
               <exclude name="**/jms/persistence/**"/>
               <exclude name="**/jms/ReferencingTest.class"/>
               <exclude name="**/jms/PersistenceTest.class"/>
               <exclude name="**/jms/crash/*Test.class"/>
               <exclude name="**/*LeakTest.class"/>
               <exclude name="**/jms/ManifestTest.class"/>
               <exclude name="**/jms/JCAWrapperTest.class"/>
               <exclude name="**/jms/manual/**/*Test.class"/>
               <exclude name="**/jms/clustering/*Test.class"/>
            </fileset>
         </batchtest>
      </junit>

      <antcall target="stop-rmi-server"/>

   </target>

   <target name="remote-stress-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs remotely all stress tests for which it makes sense to run remotely">

      <antcall target="stop-rmi-server"/>
      <antcall target="start-rmi-server-stress"/>
      <mkdir dir="${build.tests.reports}"/>

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="yes"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${stress.timeout}">

         <sysproperty key="remote" value="true"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${stress.tests.database}"/>
         <sysproperty key="test.serialization" value="${stress.tests.serialization}"/>
         <sysproperty key="test.remoting" value="${test.remoting}"/>
         <sysproperty key="test.logfile.suffix" value="remote-client"/>
         <jvmarg value="-Xmx512M"/>
         <!-- <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=unittest"/> -->
         <classpath>
            <path refid="stress.test.execution.classpath"/>
            <!-- Add this when http://jira.jboss.org/jira/browse/JBAS-2554 is done -->
            <!--
            <path refid="jboss.test.classpath"/>
            -->
         </classpath>

         <!-- Use this when http://jira.jboss.org/jira/browse/JBAS-2554 is done -->
         <!--
         <sysproperty key="jboss-junit-configuration" value="Remote"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
            usefile="${junit.formatter.usefile}" extension="-Remote.xml"/>
         -->

         <sysproperty key="messaging-test-configuration" value="StressRemote-${test.remoting}"/>
         <formatter classname="org.jboss.test.messaging.tools.ant.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}" extension="-StressRemote-${test.remoting}.xml"/>

         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/jms/stress/**/*Test.class"/>
            </fileset>
         </batchtest>
      </junit>

      <antcall target="stop-rmi-server"/>

   </target>

   <!-- internal task for clustering-tests -->
   <target name="start-clustering">
      <!-- Stop the rmi servers in case a previous run aborted -->

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="3"/>
      </antcall>

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="2"/>
      </antcall>

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="1"/>
      </antcall>

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="0"/>
      </antcall>



      <!-- Start 4 rmi servers -->

      <antcall target="start-rmi-server-clustering">
         <param name="test.server.index" value="0"/>
      </antcall>

      <antcall target="start-rmi-server-clustering">
         <param name="test.server.index" value="1"/>
      </antcall>

      <antcall target="start-rmi-server-clustering">
         <param name="test.server.index" value="2"/>
      </antcall>

      <antcall target="start-rmi-server-clustering">
         <param name="test.server.index" value="3"/>
      </antcall>

      <mkdir dir="${build.tests.reports}"/>


   </target>

   <!-- internal task for clustering-tests -->
   <target name="stop-clustering">
      <!--
          Stop the servers in the reverse order, so the VM that runs the RMI registry dies last.
      -->

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="3"/>
      </antcall>

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="2"/>
      </antcall>

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="1"/>
      </antcall>

      <antcall target="stop-rmi-server-clustering">
         <param name="test.server.index" value="0"/>
      </antcall>
   </target>

   <target name="clustering-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs the clustering tests">


      <antcall target="start-clustering"/>

      <echo message=""/>
      <echo message="Running clustering tests, fork=${junit.fork}, junit.batchtest.fork=${junit.batchtest.fork}"/>
      <echo message=""/>

      <!--

           By default, clustered tests are run in a "remote" configuration (the clustered
           nodes physically live in different VMs. If you want to test a co-located clustered
           configuration, use bin/runtest -clustered
      -->

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="yes"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">

         <sysproperty key="remote" value="true"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${clustering.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.clustered" value="true"/>
         <sysproperty key="test.logfile.suffix" value="clustering-client"/>
         <jvmarg value="-Xmx512M"/>
         <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
         <!--
         <jvmarg line="-Xmx512M -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=n,suspend=n,address=antjunit"/>
          -->

         <classpath>
            <path refid="test.execution.classpath"/>
            <!--
                Add this when http://jira.jboss.org/jira/browse/JBAS-2554 is done
            -->
            <!--
                 <path refid="jboss.test.classpath"/>
            -->
         </classpath>

         <!--
              Use this when http://jira.jboss.org/jira/browse/JBAS-2554 is done
         -->
         <!--
         <sysproperty key="jboss-junit-configuration" value="Remote"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
            usefile="${junit.formatter.usefile}" extension="-Remote.xml"/>
         -->

         <sysproperty key="messaging-test-configuration" value="Clustering"/>
         <formatter classname="org.jboss.test.messaging.tools.ant.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}" extension="-Clustering.xml"/>

         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <!--
                 I needed a way to intercept the end of a forked ant JUnit test run, in order to
                 perform clean-up, and this is it: register a JUnitTestSuiteListener as a JUnit
                 batchtest formatter, and it will get notified on a endTestSuite() event.
            -->
            <formatter classname="org.jboss.test.messaging.tools.ant.JUnitTestSuiteListener"/>

            <fileset dir="${build.tests.classes}">
               <include name="**/jms/clustering/${test-mask}.class"/>
               <exclude name="**/*LeakTest.class"/>
            </fileset>
         </batchtest>
      </junit>

      <antcall target="stop-clustering"/>

   </target>

   <target name="memory-leak-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs MemoryLeakTests, but it starts the clustering for leak-clustering-tests">


      <antcall target="start-clustering"/>

      <echo message=""/>
      <echo message="Running clustering tests, fork=${junit.fork}, junit.batchtest.fork=${junit.batchtest.fork}"/>
      <echo message=""/>

      <!--

           By default, clustered tests are run in a "remote" configuration (the clustered
           nodes physically live in different VMs. If you want to test a co-located clustered
           configuration, use bin/runtest -clustered
      -->

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="yes"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">

         <sysproperty key="remote" value="true"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${clustering.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.clustered" value="true"/>
         <sysproperty key="test.logfile.suffix" value="clustering-client"/>
         <jvmarg value="-Xmx512M"/>
         <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
         <jvmarg value="-agentlib:jbossAgent"/>
         <!--
         <jvmarg line="-Xmx512M -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=n,suspend=n,address=antjunit"/>
          -->

         <classpath>
            <path refid="test.execution.classpath"/>
            <!--
                Add this when http://jira.jboss.org/jira/browse/JBAS-2554 is done
            -->
            <!--
                 <path refid="jboss.test.classpath"/>
            -->
         </classpath>

         <!--
              Use this when http://jira.jboss.org/jira/browse/JBAS-2554 is done
         -->
         <!--
         <sysproperty key="jboss-junit-configuration" value="Remote"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
            usefile="${junit.formatter.usefile}" extension="-Remote.xml"/>
         -->

         <sysproperty key="messaging-test-configuration" value="Clustering"/>
         <formatter classname="org.jboss.test.messaging.tools.ant.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}" extension="-Clustering.xml"/>

         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <!--
                 I needed a way to intercept the end of a forked ant JUnit test run, in order to
                 perform clean-up, and this is it: register a JUnitTestSuiteListener as a JUnit
                 batchtest formatter, and it will get notified on a endTestSuite() event.
            -->
            <formatter classname="org.jboss.test.messaging.tools.ant.JUnitTestSuiteListener"/>

            <fileset dir="${build.tests.classes}">
               <include name="**/*LeakTest.class"/>
            </fileset>
         </batchtest>
      </junit>

      <antcall target="stop-clustering"/>

   </target>

   <target name="crash-tests" depends="tests-jar, prepare-testdirs, clear-test-logs"
      description="Runs crash tests">

      <antcall target="stop-rmi-server"/>

      <!--
          ClientCrashTest over "socket"
      -->

      <antcall target="start-rmi-server">
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>

      <antcall target="crash-test">
         <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashTest"/>
      </antcall>

      <!--
          ClientCrashTest over "http"
      -->

      <antcall target="start-rmi-server">
         <param name="test.remoting" value="http"/>
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>

      <antcall target="crash-test">
         <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashTest"/>
         <param name="test.remoting" value="http"/>
      </antcall>

      <!--
          ClientCrashTwoConnectionsTest over "socket"
      -->

      <antcall target="start-rmi-server">
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>


      <antcall target="crash-test">
         <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashTwoConnectionsTest"/>
      </antcall>

      <!--
          ClientCrashTwoConnectionsTest over "http"
      -->
      <antcall target="start-rmi-server">
         <param name="test.remoting" value="http"/>
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>

      <antcall target="crash-test">
         <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashTwoConnectionsTest"/>
         <param name="test.remoting" value="http"/>
      </antcall>

      <!--
          ClientCrashNegativeLeaseTest over "socket"
      -->

      <antcall target="start-rmi-server">
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>


      <antcall target="crash-test">
         <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashNegativeLeaseTest"/>
      </antcall>

      <!--
          ClientCrashNegativeLeaseTest over "http"
      -->

      <antcall target="start-rmi-server">
         <param name="test.remoting" value="http"/>
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>

      <antcall target="crash-test">
         <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashNegativeLeaseTest"/>
         <param name="test.remoting" value="http"/>
      </antcall>

      <!--
          ClientCrashZeroLeaseTest over "socket"
      -->

      <antcall target="start-rmi-server">
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>


      <antcall target="crash-test">
          <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashZeroLeaseTest"/>
      </antcall>

      <!--
          ClientCrashZeroLeaseTest over "http"
      -->

      <antcall target="start-rmi-server">
         <param name="test.remoting" value="http"/>
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>

      <antcall target="crash-test">
         <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashZeroLeaseTest"/>
         <param name="test.remoting" value="http"/>
      </antcall>

      <!--
          ClientCrashLargeLeaseTest over "socket"
      -->

      <antcall target="start-rmi-server">
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>


      <antcall target="crash-test">
          <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashLargeLeaseTest"/>
      </antcall>

      <!--
          ClientCrashLargeLeaseTest over "http"
      -->

      <antcall target="start-rmi-server">
         <param name="test.remoting" value="http"/>
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>

      <antcall target="crash-test">
          <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.ClientCrashLargeLeaseTest"/>
         <param name="test.remoting" value="http"/>
      </antcall>

      <!--
          CallbackFailureTest over "socket"
      -->

      <antcall target="start-rmi-server">
         <param name="remote.server.test.logfile.suffix" value="remote-crash"/>
      </antcall>


      <antcall target="crash-test">
          <param name="crash.test.name" value="org.jboss.test.messaging.jms.crash.CallbackFailureTest"/>
      </antcall>

      <!--
          CallbackFailureTest over "http" does not make sense
      -->

   </target>


   <target name="crash-test" depends="init" description="Runs crash test">

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="yes"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">

         <sysproperty key="remote" value="true"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <sysproperty key="test.remoting" value="${test.remoting}"/>
         <sysproperty key="test.logfile.suffix" value="crash"/>
         <jvmarg value="-Xmx512M"/>
         <!--
         <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_shmem,server=y,suspend=y,address=antjunit"/>
         -->
         <classpath>
            <path refid="test.execution.classpath"/>

            <!-- Add this when http://jira.jboss.org/jira/browse/JBAS-2554 is done -->
            <!--
            <path refid="jboss.test.classpath"/>
            -->
         </classpath>

         <!-- Use this when http://jira.jboss.org/jira/browse/JBAS-2554 is done -->
         <!--
         <sysproperty key="jboss-junit-configuration" value="Remote"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
            usefile="${junit.formatter.usefile}" extension="-Remote.xml"/>
         -->

         <sysproperty key="messaging-test-configuration" value="Crash-${test.remoting}"/>
         <formatter classname="org.jboss.test.messaging.tools.ant.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}" extension="-Crash-${test.remoting}.xml"/>

         <test name="${crash.test.name}"
               fork="true"
               todir="${junit.batchtest.todir}"
               haltonfailure="${junit.test.haltonfailure}"
               haltonerror="${junit.test.haltonerror}">
         </test>

      </junit>

   </target>


   <target name="jmstests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs the jms tests only">

      <antcall target="start-rmi-server"/>

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">
         <sysproperty key="remote" value="${build.tests.remote}"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <jvmarg value="-Xmx512M"/>
         <classpath refid="test.execution.classpath"/>
         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/messaging/jms/**/*Test.class"/>
               <exclude name="**/jms/stress/**"/>
               <exclude name="org/jboss/test/messaging/jms/ManifestTest.class"/>
               <exclude name="**/jms/clustering/*Test.class"/>
            </fileset>
         </batchtest>
      </junit>

      <antcall target="stop-rmi-server"/>

   </target>

   <target name="messagetests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs the jms tests only">

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">
         <sysproperty key="remote" value="${build.tests.remote}"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <jvmarg value="-Xmx512M"/>
         <classpath refid="test.execution.classpath"/>
         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/messaging/jms/message/**/*Test.class"/>
            </fileset>
         </batchtest>
      </junit>

      <antcall target="stop-rmi-server"/>

   </target>

   <target name="coretests" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs the jms tests only">

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">
         <sysproperty key="remote" value="${build.tests.remote}"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <jvmarg value="-Xmx512M"/>
         <classpath refid="test.execution.classpath"/>
         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <batchtest fork="${junit.batchtest.fork}"
                    todir="${junit.batchtest.todir}"
                    haltonfailure="${junit.batchtest.haltonfailure}"
                    haltonerror="${junit.batchtest.haltonerror}">
            <formatter type="plain" usefile="${junit.formatter.usefile}"/>
            <fileset dir="${build.tests.classes}">
               <include name="**/messaging/**/*Test.class"/>
               <exclude name="**/messaging/jms/**"/>
            </fileset>
         </batchtest>
      </junit>
      <antcall target="stop-rmi-server"/>
   </target>

   <target name="test" depends="tests-jar, prepare-testdirs, clear-test-logs"
           description="Runs a single test, specified by its FQ class name via 'test.classname'">

      <fail unless="test.classname"
            message="To run a single test, use: ./build.sh test -Dtest.classname=org.package.MyTest"/>
      <echo>Module root is:${module.root}</echo>
      <antcall target="start-rmi-server"/>
      <property name="test.classname" value="dummy"/>

      <junit printsummary="${junit.printsummary}"
             fork="${junit.fork}"
             includeantruntime="${junit.includeantruntime}"
             haltonerror="${junit.haltonerror}"
             haltonfailure="${junit.haltonfailure}"
             showoutput="${junit.showoutput}"
             timeout="${junit.timeout}">
         <sysproperty key="remote" value="${build.tests.remote}"/>
         <sysproperty key="module.output" value="${tests.output}"/>
         <sysproperty key="test.bind.address" value="${test.bind.address}"/>
         <sysproperty key="test.database" value="${functional.tests.database}"/>
         <sysproperty key="test.serialization" value="${functional.tests.serialization}"/>
         <!--
            <jvmarg line="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=y"/>
         -->
         <jvmarg value="-Xmx1024M"/>
         <classpath refid="test.execution.classpath"/>
         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <test name="${test.classname}"
               fork="false"
               todir="${junit.batchtest.todir}"
               haltonfailure="${junit.test.haltonfailure}"
               haltonerror="${junit.test.haltonerror}">
         </test>
      </junit>
      <antcall target="stop-rmi-server"/>
   </target>

   <!-- ======================================================================================== -->
   <!-- Report Tasks                                                                             -->
   <!-- ======================================================================================== -->

   <target name="copy-stylesheets">
      <mkdir dir="${build.tests.stylesheets}"/>
      <copy todir="${build.tests.stylesheets}" filtering="yes">
         <fileset dir="${source.tests.stylesheets}">
            <include name="**/*"/>
         </fileset>
      </copy>
   </target>

   <target name="compile-report" depends="copy-stylesheets">
      <mkdir dir="${build.tests.reports}/html"/>
      <junitreport todir="${build.tests.reports}">
         <fileset dir="${build.tests.reports}">
            <include name="TEST-*.xml"/>
         </fileset>
         <report format="frames"
                 todir="${build.tests.reports}/html"
                 styledir="${build.tests.stylesheets}"/>
      </junitreport>
   </target>

   <target name="report" depends="tests, copy-stylesheets, compile-report"/>

   <target name="remote-tests-report" depends="remote-tests, copy-stylesheets, compile-report"/>

   <target name="jmsreport" depends="jmstests, copy-stylesheets, compile-report"/>

   <target name="messagereport" depends="messagetests, copy-stylesheets, compile-report"/>

   <target name="corereport" depends="coretests, copy-stylesheets, compile-report"/>

   <target name="stressreport" depends="stress-tests, copy-stylesheets, compile-report"/>

   <target name="functional-tests" depends="tests"/>

   <!-- ======================================================================================== -->
   <!-- Cleaning Tasks                                                                           -->
   <!-- ======================================================================================== -->

   <target name="clean">
      <delete dir="${tests.output}"/>
      <delete quiet="true">
         <fileset dir="./bin">
            <include name=".*.classpath"/>
         </fileset>
      </delete>
   </target>

   <!-- ======================================================================================== -->
   <!-- Tasks required by bin/runtest                                                            -->
   <!-- ======================================================================================== -->

   <property name="test.execution.classpath.file" value=".test.execution.classpath"/>

   <target name="get-test-execution-classpath" depends="init">
      <pathconvert refid="test.execution.classpath"
                   property="test.execution.classpath.unix"/>
      <echo message="${test.execution.classpath.unix}" file="${test.execution.classpath.file}"/>
   </target>

   <!-- ======================================================================================== -->
   <!-- Miscellaneous                                                                            -->
   <!-- ======================================================================================== -->

   <target name="tests-ejb-jar"
           depends="compile"
           description="Creates the ejb jar file containing the test ejb and mdb for testing jms from within a managed environment">

      <mkdir dir="${build.tests.lib}"/>
      <mkdir dir="${build.tests.classes}/META-INF"/>
      <copy file="${source.tests.java}/org/jboss/test/messaging/jms/managed/META-INF/jboss.xml"
            tofile="${build.tests.classes}/META-INF/jboss.xml"/>
      <copy file="${source.tests.java}/org/jboss/test/messaging/jms/managed/META-INF/ejb-jar.xml"
            tofile="${build.tests.classes}/META-INF/ejb-jar.xml"/>
      <!-- Build the tests ejb jar -->
      <jar jarfile="${build.tests.lib}/${build.tests.ejbarchive}">
         <fileset dir="${build.tests.classes}">
            <include name="org/jboss/test/messaging/jms/managed/**"/>
         </fileset>
         <fileset dir="${build.tests.classes}">
            <include name="META-INF/**"/>
         </fileset>
      </jar>
   </target>

   <target name="deployejb" depends="tests-ejb-jar">
      <copy file="${build.tests.lib}/${build.tests.ejbarchive}"
            todir="${ENV.JBOSS_HOME}/server/default/deploy"/>
   </target>

   <target name="undeployejb">
      <delete file="${ENV.JBOSS_HOME}/server/default/deploy/${build.tests.ejbarchive}"/>
   </target>

</project>

