<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id$ -->

<project default="all" name="Messaging Smoke Test Suite">

   <property environment="ENV"/>
   <property file="./output/last-run.properties"/>
   <property file="./smoke.properties"/>
   <property name="sleep.interval" value="60"/>
   <property name="jnpPort" value="1099"/>
   <property name="messaging.server.artifact.name" value="jboss-messaging.sar"/>
   <property name="messaging.server.artifact.path" value="../../output/lib"/>
   <property name="relative.client.jar.location" value="../../util"/>
   <property name="messaging.client.jar.name" value="jboss-messaging-client.jar"/>
   <property name="release.admin.target" value="default"/>
   <property name="jboss.configuration" value="messaging-smoke-test"/>
   <property name="messaging.client.jar.path" value="${basedir}/../../output/lib"/>
   <property name="smoke.test.type" value="installation"/>
   <property name="clustered" value="false"/>

   <property name="password" value="admin"/>
   <property name="user" value="admin"/>

   <!--
        By default, each test (installation or compatiblity) runs all examples. If you want to
        prevent a specific example from running during a test, set run.<examplename>.example=false
        in the corresponding "installation-test" or "compatibility-test" antcall.
   -->
   <property name="run.queue.example" value="true"/>
   <property name="run.topic.example" value="true"/>
   <property name="run.mdb.example" value="true"/>
   <property name="run.mdb-failure.example" value="true"/>
   <property name="run.http.example" value="true"/>
   <property name="run.stateless.example" value="true"/>
   <property name="run.ejb3mdb.example" value="false"/>
   <property name="run.secure-socket.example" value="true"/>
   <property name="run.distributed-queue.example" value="true"/>
   <property name="run.distributed-topic.example" value="true"/>
   <property name="run.queue-failover.example" value="true"/>

   <property name="jboss.home" value="${jboss.compatibility.home}"/>

   <path id="twiddle.classpath">
      <pathelement location="${jboss.home}/bin/twiddle.jar"/>
      <pathelement location="${jboss.home}/client/jbossall-client.jar"/>
      <pathelement location="${jboss.home}/client/getopt.jar"/>
      <pathelement location="${jboss.home}/client/log4j.jar"/>
      <pathelement location="${jboss.home}/lib/jboss-jmx.jar"/>
      <pathelement location="${jboss.home}/lib/dom4j.jar"/>
   </path>

   <!-- ======================================================================== -->
   <!--      Configurable Targets                                                -->
   <!-- ======================================================================== -->

   <target name="insure-smoke-properties">
      <available file="./smoke.properties" property="smoke.properties.present"/>
      <fail message="The ./smoke.properties file NOT available. Create one based on 'smoke.properties.example' and try again."
            unless="smoke.properties.present"/>
   </target>

   <target name="all" depends="insure-smoke-properties">
      <mkdir dir="./output"/>
      <delete file="./output/smoke.log" quiet="true"/>
      <antcall target="build-deployment-archives-from-scratch"/>

      <antcall target="installation-tests"/>

      <antcall target="old-server-compatibility-tests">
         <param name="smoke.test.type" value="client.compatibility"/>
      </antcall>

      <antcall target="old-client-compatibility-tests">
         <param name="smoke.test.type" value="server.compatibility"/>
      </antcall>

      <antcall target="report"/>
   </target>

   <target name="installation-tests">

      <!-- We only support 4.2.0.GA and later - so we only smoke against that -->


      <!--
           4.2.0.GA
      -->

      
      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss420GA.home}"/>
         <param name="install-jars" value="no"/>
      </antcall>
      

      <!--
           4.0.5.GA
      -->

      <!--
      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss405GA.home}"/>
         <param name="install-jars" value="yes"/>
         <param name="run.secure-socket.example" value="false"/>
         <param name="run.http.example" value="false"/>
      </antcall>

      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss405GA-installer.home}"/>
         <param name="install-jars" value="yes"/>
         <param name="run.secure-socket.example" value="false"/>
         <param name="run.http.example" value="false"/>
      </antcall>

      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss405GA.home}"/>
         <param name="release.admin.target" value="standalone"/>
         <param name="run.mdb.example" value="false"/>
         <param name="run.mdb-failure.example" value="false"/>
         <param name="run.stateless.example" value="false"/>
         <param name="run.secure-socket.example" value="false"/>
         <param name="install-jars" value="yes"/>
         <param name="run.http.example" value="false"/>
      </antcall>

      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss405GAejb3.home}"/>
         <param name="no.java4" value="true"/>
         <param name="run.ejb3mdb.example" value="true"/>
         <param name="run.secure-socket.example" value="false"/>
         <param name="install-jars" value="yes"/>
         <param name="run.http.example" value="false"/>
      </antcall>
      -->
      
      <!--
           4.0.4.GA
      -->
      <!--
      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss404GA.home}"/>
         <param name="run.secure-socket.example" value="false"/>
         <param name="run.http.example" value="false"/>
      </antcall>

      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss404GA-installer.home}"/>
         <param name="run.secure-socket.example" value="false"/>
         <param name="run.http.example" value="false"/>
      </antcall>

      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss404GA.home}"/>
         <param name="release.admin.target" value="standalone"/>
         <param name="run.mdb.example" value="false"/>
         <param name="run.mdb-failure.example" value="false"/>
         <param name="run.stateless.example" value="false"/>
         <param name="run.secure-socket.example" value="false"/>
         <param name="run.http.example" value="false"/>
      </antcall>
      -->

      <!--
           4.0.3SP1
      -->
      <!--
      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss403SP1.home}"/>
         <param name="run.secure-socket.example" value="false"/>
      </antcall>

      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss403SP1-installer.home}"/>
         <param name="run.secure-socket.example" value="false"/>
      </antcall>
      -->

      <!--
           4.0.3
      -->
      <!--
      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss403.home}"/>
         <param name="run.secure-socket.example" value="false"/>
      </antcall>

      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss403-installer.home}"/>
         <param name="run.secure-socket.example" value="false"/>
      </antcall>
      -->
      <!--
           4.0.2
      -->
      <!--
      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss402.home}"/>
         <param name="run.secure-socket.example" value="false"/>
      </antcall>
      -->

      <!--
          Note on installer versions.
          When installing versions to test via the JBoss installer, make sure call by value is *not*
          selected in the installation process. The reason for testing installer versions is to test
          the arrangement where JBoss is configured for all pass by reference
      -->

      <!--
           4.0.1sp1 - not supported on non scopped
      -->

      <!-- <antcall target="installation-test">
         <param name="jboss.home" value="${jboss401sp1.home}"/>
         <param name="run.secure-socket.example" value="false"/>
      </antcall> -->

      <!--
           4.0.3SP1 standalone. Temporarily removed from the supported configurations list.
           See http://jira.jboss.org/jira/browse/JBMESSAGING-848
      -->
      <!--
      <antcall target="installation-test">
         <param name="jboss.home" value="${jboss403SP1.home}"/>
         <param name="release.admin.target" value="standalone"/>
         <param name="run.mdb.example" value="false"/>
         <param name="run.mdb-failure.example" value="false"/>
         <param name="run.stateless.example" value="false"/>
         <param name="run.secure-socket.example" value="false"/>
      </antcall>
      -->

   </target>

   <target name="old-server-compatibility-tests">

      <!-- ====================================================  -->
      <!--                                                       -->
      <!--  Add here other old server versions to test:          -->
      <!--                                                       -->
      <!-- ====================================================  -->

      <!--

           http://jira.jboss.com/jira/browse/JBMESSAGING-427
           Due to fix to handle long strings. We can no longer guarantee compatibility for versions < 1.0.3
      -->

      <!--

      <antcall target="old-server-compatibility-test">
         <param name="jboss.home" value="${jboss.compatibility.home}"/>
         <param name="jboss.messaging.version" value="1.0.1.CR1"/>
      </antcall>

      <antcall target="old-server-compatibility-test">
         <param name="jboss.home" value="${jboss.compatibility.home}"/>
         <param name="jboss.messaging.version" value="1.0.1.CR2"/>
      </antcall>

      -->

   </target>

   <target name="old-client-compatibility-tests">

      <!--

      <antcall target="create-messaging-config">
         <param name="jboss.home" value="${jboss.compatibility.home}"/>
         <param name="jboss.configuration" value="current-version-server"/>
      </antcall>

      -->

      <!-- ====================================================  -->
      <!--                                                       -->
      <!--  Add here other old client versions to test:          -->
      <!--                                                       -->
      <!-- ====================================================  -->

      <!--
           http://jira.jboss.com/jira/browse/JBMESSAGING-427
           Due to fix to handle long strings. We can no longer guarantee compatibility for versions < 1.0.3
      -->

      <!--

      <antcall target="old-client-compatibility-test">
         <param name="jboss.home" value="${jboss.compatibility.home}"/>
         <param name="jboss.configuration" value="current-version-server"/>
         <param name="jboss.messaging.version" value="1.0.1.CR1"/>
      </antcall>

      <antcall target="old-client-compatibility-test">
         <param name="jboss.home" value="${jboss.compatibility.home}"/>
         <param name="jboss.configuration" value="current-version-server"/>
         <param name="jboss.messaging.version" value="1.0.1.CR2"/>
      </antcall>

      -->

      <!--

      <antcall target="clean-messaging-config">
         <param name="jboss.home" value="${jboss.compatibility.home}"/>
         <param name="jboss.configuration" value="current-version-server"/>
      </antcall>

      -->

   </target>

   <target name="run-all-examples">

      <antcall target="start"/>
      <antcall target="record-running-jboss-instance"/>
      <antcall target="sleep"><param name="sleep.interval" value="40"/></antcall>

      <antcall target="ping-jms-server"/>

      <antcall target="deploy-queue"/>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-queue">
         <param name="example.queue.name" value="SmokeTestQueue"/>
      </antcall>

      <antcall target="deploy-topic"/>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-topic">
         <param name="example.topic.name" value="SmokeTestTopic"/>
      </antcall>

      <!-- ====================================================  -->
      <!--                                                       -->
      <!--  LIST YOUR NON-CLUSTERED EXAMPLES HERE:               -->
      <!--                                                       -->
      <!-- ====================================================  -->

      <antcall target="run-example">
         <param name="example.name" value="queue"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="topic"/>
         <param name="example.topic.name" value="SmokeTestTopic"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="mdb"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.home" value="${jboss.home}"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="mdb-failure"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.home" value="${jboss.home}"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="stateless"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.home" value="${jboss.home}"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="ejb3mdb"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.home" value="${jboss.home}"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="secure-socket"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.home" value="${jboss.home}"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="http"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.home" value="${jboss.home}"/>
      </antcall>

      <!-- ====================================================  -->
      <!--                                                       -->
      <!--  END OF NON-CLUSTERED EXAMPLE LIST                    -->
      <!--                                                       -->
      <!-- ====================================================  -->

      <antcall target="stop"/>
      <antcall target="sleep"><param name="sleep.interval" value="10"/></antcall>
      <antcall target="display-warnings-and-errors"/>

   </target>

   <target name="run-all-clustered-examples">

      <!--
          Start node0.
      -->

      <antcall target="start">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>
      <antcall target="record-running-jboss-instance">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="40"/></antcall>
      <antcall target="ping-jms-server"/>

      <!--
          Deploy the non-clustered queue, we'll also run non-clustered examples in a clustered
          configuration.
      -->

      <antcall target="deploy-queue">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-queue">
         <param name="example.queue.name" value="SmokeTestQueue"/>
      </antcall>

      <!--
          Deploy the clustered queue.
      -->

      <antcall target="deploy-clustered-queue">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-queue">
         <param name="example.queue.name" value="DistributedSmokeTestQueue"/>
      </antcall>

      <!--
          Deploy the non-clustered topic, we'll also run non-clustered examples in a clustered
          configuration.
      -->

      <antcall target="deploy-topic">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-topic">
         <param name="example.topic.name" value="SmokeTestTopic"/>
      </antcall>

      <!--
          Deploy the clustered topic.
      -->

      <antcall target="deploy-clustered-topic">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-topic">
         <param name="example.topic.name" value="DistributedSmokeTestTopic"/>
      </antcall>

      <!--
          Start node1.
      -->

      <antcall target="start">
         <param name="jboss.configuration" value="${jboss.configuration}-node1"/>
      </antcall>
      <antcall target="record-running-jboss-instance1">
         <param name="jboss.configuration" value="${jboss.configuration}-node1"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="40"/></antcall>
      <antcall target="ping-jms-server">
         <param name="jnpPort" value="1199"/>
      </antcall>

      <!--
          Deploy the clustered queue.
      -->

      <antcall target="deploy-clustered-queue">
         <param name="jboss.configuration" value="${jboss.configuration}-node1"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-queue">
         <param name="example.queue.name" value="DistributedSmokeTestQueue"/>
         <param name="jnpPort" value="1199"/>
      </antcall>


      <!--
          Deploy the clustered topic.
      -->

      <antcall target="deploy-clustered-topic">
         <param name="jboss.configuration" value="${jboss.configuration}-node1"/>
      </antcall>
      <antcall target="sleep"><param name="sleep.interval" value="8"/></antcall>
      <antcall target="ping-topic">
         <param name="example.topic.name" value="DistributedSmokeTestTopic"/>
         <param name="jnpPort" value="1199"/>
      </antcall>

      <!-- ====================================================  -->
      <!--                                                       -->
      <!--  LIST YOUR CLUSTERED EXAMPLES HERE:                   -->
      <!--                                                       -->
      <!-- ====================================================  -->

      <!--
           Single-node examples that runs in a clustered configuration. The list should be
           identical with the one used for non-clustered tests
      -->
      <antcall target="run-example">
         <param name="example.name" value="queue"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="topic"/>
         <param name="example.topic.name" value="SmokeTestTopic"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="mdb"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="mdb-failure"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="stateless"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="ejb3mdb"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="secure-socket"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <antcall target="run-example">
         <param name="example.name" value="http"/>
         <param name="example.queue.name" value="SmokeTestQueue"/>
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
         <param name="clustered" value="true"/>
      </antcall>

      <!--
           Genuine clustered examples.
      -->

      <antcall target="run-clustered-example">
         <param name="example.name" value="distributed-queue"/>
         <param name="example.queue.name" value="DistributedSmokeTestQueue"/>
      </antcall>

      <antcall target="run-clustered-example">
         <param name="example.name" value="distributed-topic"/>
         <param name="example.topic.name" value="DistributedSmokeTestTopic"/>
      </antcall>

      <antcall target="run-clustered-example">
         <param name="example.name" value="queue-failover"/>
         <param name="example.queue.name" value="DistributedSmokeTestQueue"/>
      </antcall>

      <!-- ====================================================  -->
      <!--                                                       -->
      <!--  END OF CLUSTERED EXAMPLE LIST                        -->
      <!--                                                       -->
      <!-- ====================================================  -->

      <!-- this will stop both nodes -->
      <antcall target="stop"/>

      <antcall target="sleep"><param name="sleep.interval" value="20"/></antcall>

      <antcall target="display-warnings-and-errors">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>

      <antcall target="display-warnings-and-errors">
         <param name="jboss.configuration" value="${jboss.configuration}-node1"/>
      </antcall>

   </target>

   <target name="run-example">

      <!--
           Determine if a specific example should run with a specific test; to prevent a test from
           running an example, set "run.<examplename>.example to false.
       -->
      <condition property="do.run" value="true">
         <or>
            <and>
               <equals arg1="${example.name}" arg2="queue"/>
               <istrue value="${run.queue.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="topic"/>
               <istrue value="${run.topic.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="mdb"/>
               <istrue value="${run.mdb.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="mdb-failure"/>
               <istrue value="${run.mdb-failure.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="stateless"/>
               <istrue value="${run.stateless.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="ejb3mdb"/>
               <istrue value="${run.ejb3mdb.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="secure-socket"/>
               <istrue value="${run.secure-socket.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="http"/>
               <istrue value="${run.http.example}"/>
            </and>
         </or>
      </condition>
      <antcall target="run-example-internal"/>

   </target>

   <target name="run-clustered-example">

      <!--
           Determine if a specific example should run with a specific test; to prevent a test from
           running an example, set "run.<examplename>.example to false.
       -->
      <condition property="do.run" value="true">
         <or>
            <and>
               <equals arg1="${example.name}" arg2="distributed-queue"/>
               <istrue value="${run.distributed-queue.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="distributed-topic"/>
               <istrue value="${run.distributed-topic.example}"/>
            </and>
            <and>
               <equals arg1="${example.name}" arg2="queue-failover"/>
               <istrue value="${run.queue-failover.example}"/>
            </and>
         </or>
      </condition>
      <antcall target="run-clustered-example-internal"/>

   </target>

   <!-- ======================================================================== -->
   <!--      Internal Targets                                                    -->
   <!-- ======================================================================== -->

   <target name="installation-test"
           depends="check-java-version, check-jboss-availability" unless="skip.current.java">

      <echo message="Testing installation on ${jboss.home}"/>
      <!--
          Run single-node tests
      -->
      <antcall target="create-messaging-config">
         <param name="install-jars" value="${install-jars}"/>
      </antcall>

      <antcall target="run-all-examples"/>
      <antcall target="clean-messaging-config"/>

      <!--
          Run clustered tests
      -->
      <antcall target="create-clustered-messaging-config">
         <param name="install-jars" value="${install-jars}"/>
      </antcall>

      <antcall target="run-all-clustered-examples"/>
      <antcall target="clean-clustered-messaging-config"/>
                                                                                                 
   </target>

   <target name="check-java-version">
      <condition property="skip.current.java" value="true">
         <or>
            <and>
               <istrue value="${no.java4}"/>
               <equals arg1="1.4" arg2="${ant.java.version}"/>
            </and>
            <and>
               <istrue value="${no.java5}"/>
               <equals arg1="1.5" arg2="${ant.java.version}"/>
            </and>
         </or>
      </condition>
   </target>

   <target name="old-server-compatibility-test" depends="check-jboss-availability">

      <echo message="Checking current client's compatibility with a ${jboss.messaging.version} server"/>
      <unzip src="${jboss.compatibility.home}/../jboss-messaging-${jboss.messaging.version}.zip" dest="./output">
         <patternset>
            <include name="jboss-messaging-${jboss.messaging.version}/jboss-messaging.sar"/>
         </patternset>
      </unzip>
      <antcall target="create-messaging-config">
         <param name="messaging.server.artifact.path" value="./output/jboss-messaging-${jboss.messaging.version}"/>
         <param name="jboss.configuration" value="messaging-${jboss.messaging.version}"/>
      </antcall>
      <antcall target="run-all-examples">
         <param name="jboss.configuration" value="messaging-${jboss.messaging.version}"/>
      </antcall>
      <delete dir="./output/jboss-messaging-${jboss.messaging.version}"/>
      <antcall target="clean-messaging-config">
         <param name="jboss.configuration" value="messaging-${jboss.messaging.version}"/>
      </antcall>

   </target>

   <target name="old-client-compatibility-test" depends="check-jboss-availability">

      <echo message="Checking current server's compatibility with a ${jboss.messaging.version} client"/>
      <unzip src="${jboss.compatibility.home}/../jboss-messaging-${jboss.messaging.version}.zip" dest="./output">
         <patternset>
            <include name="jboss-messaging-${jboss.messaging.version}/jboss-messaging-client.jar"/>
         </patternset>
      </unzip>
      <antcall target="run-all-examples">
         <param name="messaging.client.jar.path" value="${basedir}/output/jboss-messaging-${jboss.messaging.version}"/>
      </antcall>
      <delete dir="./output/jboss-messaging-${jboss.messaging.version}"/>

   </target>

   <target name="create-messaging-config">

      <available file="${messaging.server.artifact.path}/${messaging.server.artifact.name}" property="archive.present"/>
      <fail unless="archive.present">Cannot find deployment archive ${messaging.server.artifact.path}/${messaging.server.artifact.name}</fail>
      <ant antfile="../../util/release-admin.xml" target="${release.admin.target}">
         <property name="jboss.home" value="${jboss.home}"/>
         <property name="messaging.config.name" value="${jboss.configuration}"/>
         <property name="standalone.messaging.config.name" value="${jboss.configuration}"/>
         <property name="main.artifact.location" value="${messaging.server.artifact.path}"/>
         <property name="messaging.artifact.name" value="${messaging.server.artifact.name}"/>         
         <property name="install-jars" value="${install-jars}"/>
      </ant>
      <available file="../../output/lib/jboss-messaging-client.jar" property="client.jar.present"/>
      <fail unless="client.jar.present">Cannot find the client jar ../../output/lib/jboss-messaging-client.jar</fail>

   </target>

   <target name="create-clustered-messaging-config">

      <available file="${messaging.server.artifact.path}/${messaging.server.artifact.name}" property="archive.present"/>
      <fail unless="archive.present">Cannot find deployment archive ${messaging.server.artifact.path}/${messaging.server.artifact.name}</fail>

      <available file="../../output/lib/jboss-messaging-client.jar" property="client.jar.present"/>
      <fail unless="client.jar.present">Cannot find the client jar ../../output/lib/jboss-messaging-client.jar</fail>

      <!--
          create node 0
      -->
      <ant antfile="../../util/release-admin.xml" target="cluster-node">
         <property name="jboss.home" value="${jboss.home}"/>
         <property name="messaging.config.name" value="${jboss.configuration}"/>
         <property name="main.artifact.location" value="${messaging.server.artifact.path}"/>
         <property name="messaging.artifact.name" value="${messaging.server.artifact.name}"/>
         <property name="auxiliary.artifacts.location" value="../../src/etc/server/default/deploy"/>
         <property name="auxiliary.lib.location" value="../../util/lib"/>
         <property name="driver-jar" value="${driver-jar}"/>
         <property name="install-jars" value="${install-jars}"/>
      </ant>

      <!--
          create node 1
      -->
      <ant antfile="../../util/release-admin.xml" target="cluster-node">
         <property name="id" value="1"/>
         <property name="ports" value="ports-01"/>
         <property name="jboss.home" value="${jboss.home}"/>
         <property name="messaging.config.name" value="${jboss.configuration}"/>
         <property name="main.artifact.location" value="${messaging.server.artifact.path}"/>
         <property name="messaging.artifact.name" value="${messaging.server.artifact.name}"/>
         <property name="auxiliary.artifacts.location" value="../../src/etc/server/default/deploy"/>
         <property name="auxiliary.lib.location" value="../../util/lib"/>
         <property name="driver-jar" value="${driver-jar}"/>
         <property name="install-jars" value="${install-jars}"/>
      </ant>

   </target>

   <target name="clean-messaging-config" description="Cleans the non-clustered JBoss instance, and also the clustered ones, if necessary">
      <fail unless="jboss.home" message="jboss.home property not set!"/>
      <echo message="Cleaning ${jboss.home}/server/${jboss.configuration}"/>
      <delete dir="${jboss.home}/server/${jboss.configuration}" quiet="false" failonerror="true"/>
      <antcall target="clean-messaging-config1"/>
      <delete file="./output/last-run.properties" quiet="true"/>
   </target>

   <target name="clean-messaging-config1" description="Cleans the second clustered JBoss instance" if="jboss.home1">
      <fail unless="jboss.home1" message="jboss.home1 property not set!"/>
      <fail unless="jboss.configuration1" message="jboss.configuration1 property not set!"/>
      <echo message="Cleaning ${jboss.home1}/server/${jboss.configuration1}"/>
      <delete dir="${jboss.home1}/server/${jboss.configuration1}" quiet="false" failonerror="true"/>
   </target>

   <target name="clean-clustered-messaging-config" description="Cleans all clustered JBoss configurations">
      <fail unless="jboss.home" message="jboss.home property not set!"/>
      <echo message="Cleaning ${jboss.home}/server/${jboss.configuration}-node0"/>
      <delete dir="${jboss.home}/server/${jboss.configuration}-node0" quiet="false" failonerror="true"/>
      <echo message="Cleaning ${jboss.home}/server/${jboss.configuration}-node1"/>
      <delete dir="${jboss.home}/server/${jboss.configuration}-node1" quiet="false" failonerror="true"/>
      <delete file="./output/last-run.properties" quiet="true"/>
   </target>

   <!-- don't call this target directly, call it via "run-example" -->
   <target name="run-example-internal" if="do.run">

      <antcall target="run-example-internal-common"/>

      <antcall target="display-warnings-and-errors"/>
      <antcall target="fail-on-serialization-debug-output"/>

      <!-- record successful run -->
      <echo message="TEST_TYPE=${smoke.test.type} JBOSS_HOME=${jboss.home} JBOSS_CONFIGURATION=${jboss.configuration} CLIENT_VERSION=${jboss.messaging.version} INSTALLATION_TYPE=${release.admin.target} SERVER_ARTIFACT_NAME=${messaging.server.artifact.name} EXAMPLE_NAME=${example.name}  CLUSTERED=${clustered}${line.separator}"
            file="./output/smoke.log" append="yes"/>

   </target>

   <!-- don't call this target directly, call it via "run-example" -->
   <target name="run-clustered-example-internal" if="do.run">

      <antcall target="run-example-internal-common"/>

      <antcall target="display-warnings-and-errors">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>

      <antcall target="display-warnings-and-errors">
         <param name="jboss.configuration" value="${jboss.configuration}-node1"/>
      </antcall>

      <antcall target="fail-on-serialization-debug-output">
         <param name="jboss.configuration" value="${jboss.configuration}-node0"/>
      </antcall>

      <antcall target="fail-on-serialization-debug-output">
         <param name="jboss.configuration" value="${jboss.configuration}-node1"/>
      </antcall>

      <!-- record successful run -->
      <echo message="TEST_TYPE=${smoke.test.type} JBOSS_HOME=${jboss.home} JBOSS_CONFIGURATION=${jboss.configuration}-node0 CLIENT_VERSION=${jboss.messaging.version} INSTALLATION_TYPE=${release.admin.target} SERVER_ARTIFACT_NAME=${messaging.server.artifact.name} EXAMPLE_NAME=${example.name} CLUSTERED=true${line.separator}"
            file="./output/smoke.log" append="yes"/>

   </target>

   <target name="run-example-internal-common">

      <ant dir="../../docs/examples/${example.name}" antfile="build.xml" target="clean"/>

      <ant dir="../../docs/examples/${example.name}" antfile="build.xml"/>

      <echo message="Example ${example.name} executed successfully, cleaning ..."/>

      <ant dir="../../docs/examples/${example.name}" antfile="build.xml" target="clean"/>

   </target>

   <target name="check-jboss-availability">

      <fail unless="jboss.home">jboss.home property not set!</fail>

   </target>

   <target name="sleep">

      <echo message="Sleeping for ${sleep.interval} seconds ..."/>
      <sleep seconds="${sleep.interval}"/>

   </target>

   <target name="build-deployment-archives-from-scratch">

      <ant dir="../.." antfile="build.xml" target="clean" inheritAll="false"/>
      <ant dir="../.." antfile="build.xml" target="artifacts" inheritAll="false"/>
      <!--
           I need this because the smoke test itself uses org.jboss.test.messaging.tools classes.
      -->
      <ant dir="../../tests" antfile="build.xml" target="compile" inheritAll="false"/>

   </target>

   <target name="start" description="Starts the jboss instance">

      <fail unless="jboss.home" message="jboss.home property not set!"/>
      <echo message="Starting '${jboss.configuration}' config on ${jboss.home}"/>
      <java classname="org.jboss.Main" fork="yes" spawn="yes" dir="${jboss.home}/bin">
         <jvmarg value="-server"/>
         <jvmarg value="-Xms128m"/>
         <jvmarg value="-Xmx128m"/>
         <arg value="-c"/>
         <arg value="${jboss.configuration}"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.home}/lib/endorsed"/>
         <classpath>
            <pathelement location="${jboss.home}/bin/run.jar"/>
            <pathelement location="${java.home}/lib/tools.jar"/>
         </classpath>
      </java>

   </target>

   <target name="record-running-jboss-instance">
      <path id="crt.jboss.home"><pathelement location="${jboss.home}"/></path>
      <pathconvert targetos="unix" property="crt.jboss.home.tostring" refid="crt.jboss.home"/>
      <echo message="${line.separator}jboss.home=${crt.jboss.home.tostring}" file="./output/last-run.properties" append="true"/>
      <echo message="${line.separator}jboss.configuration=${jboss.configuration}" file="./output/last-run.properties" append="true"/>
   </target>

   <target name="record-running-jboss-instance1">
      <path id="crt.jboss.home"><pathelement location="${jboss.home}"/></path>
      <pathconvert targetos="unix" property="crt.jboss.home.tostring" refid="crt.jboss.home"/>
      <echo message="${line.separator}jboss.home1=${crt.jboss.home.tostring}" file="./output/last-run.properties" append="true"/>
      <echo message="${line.separator}jboss.configuration1=${jboss.configuration}" file="./output/last-run.properties" append="true"/>
   </target>

   <target name="twiddle">

      <java classname="org.jboss.console.twiddle.Twiddle" fork="yes" failonerror="yes"
            dir="${jboss.home}/bin">
         <arg line="-help"/>
         <classpath>
            <path refid="twiddle.classpath"/>
         </classpath>
      </java>

   </target>

   <target name="ping-jms-server">

      <java classname="org.jboss.console.twiddle.Twiddle" fork="yes" failonerror="yes"
            dir="${jboss.home}/bin">
         <arg line="-s jnp://localhost:${jnpPort} get jboss.messaging:service=ServerPeer serverPeerID"/>
         <classpath>
            <path refid="twiddle.classpath"/>
         </classpath>
      </java>

   </target>

   <target name="deploy-queue">
      <copy file="artifacts/smoketest-queue-service.xml"
            todir="${jboss.home}/server/${jboss.configuration}/deploy"/>
   </target>

   <target name="ping-queue">
      <java classname="org.jboss.console.twiddle.Twiddle" fork="yes" failonerror="yes"
          dir="${jboss.home}/bin">
         <arg line="-s jnp://localhost:${jnpPort} get jboss.messaging.destination:name=${example.queue.name},service=Queue Name"/>
         <classpath>
            <path refid="twiddle.classpath"/>
         </classpath>
      </java>
   </target>

   <target name="deploy-topic">
       <copy file="artifacts/smoketest-topic-service.xml"
             todir="${jboss.home}/server/${jboss.configuration}/deploy"/>
   </target>

   <target name="deploy-clustered-topic">
      <copy file="artifacts/smoketest-clustered-topic-service.xml"
      	    todir="${jboss.home}/server/${jboss.configuration}/deploy"/>
   </target>

   <target name="ping-topic">
      <java classname="org.jboss.console.twiddle.Twiddle" fork="yes" failonerror="yes"
          dir="${jboss.home}/bin">
         <arg line="-s jnp://localhost:${jnpPort} get jboss.messaging.destination:name=${example.topic.name},service=Topic Name"/>
         <classpath>
            <path refid="twiddle.classpath"/>
         </classpath>
      </java>
   </target>

   <target name="stop" description="Stops the unique (or the first in a cluster) JBoss instance">

      <fail unless="jboss.home" message="jboss.home property not set!"/>
      <java classname="org.jboss.Shutdown" fork="yes" dir="${jboss.home}/bin">
         <jvmarg value="-server"/>
         <jvmarg value="-Xms128m"/>
         <jvmarg value="-Xmx128m"/>
         <arg line="-s jnp://localhost:${jnpPort} -S"/>
         <arg value="--user=${user}"/>
         <arg value="--password=${password}"/>
         <classpath>
            <pathelement location="${jboss.home}/bin/shutdown.jar"/>
            <pathelement location="${jboss.home}/client/jbossall-client.jar"/>
         </classpath>
      </java>

      <antcall target="stop1">
         <param name="jnpPort" value="1199"/>
      </antcall>

   </target>

   <target name="stop1" description="Stops the second cluster instance" if="jboss.home1">

      <fail unless="jboss.home1" message="jboss.home1 property not set!"/>
      <java classname="org.jboss.Shutdown" fork="yes" dir="${jboss.home}/bin">
         <jvmarg value="-server"/>
         <jvmarg value="-Xms128m"/>
         <jvmarg value="-Xmx128m"/>
         <arg line="-s jnp://localhost:${jnpPort} -S"/>
         <arg value="--user=${user}"/>
         <arg value="--password=${password}"/>
         <classpath>
            <pathelement location="${jboss.home}/bin/shutdown.jar"/>
            <pathelement location="${jboss.home}/client/jbossall-client.jar"/>
         </classpath>
      </java>
   </target>

   <target name="display-warnings-and-errors">

      <java classname="org.jboss.test.messaging.tools.ant.DisplayWarningsAndErrors">
         <arg value="${jboss.home}/server/${jboss.configuration}/log/server.log"/>
         <arg value="WARN  [org.jboss.messaging.core.plugin.JDBCPersistenceManager] "/>
         <arg value="ejb3.deployer/"/> <!-- EJB3 doesn't deploy with java 1.4 -->
         <arg value="ejb3-interceptors-aop.xml"/> <!-- EJB3 doesn't deploy with java 1.4 -->
         <arg value="WARN  [org.jboss.system.ServiceController] Problem creating service jboss.aop:service=AspectManager"/>
         <arg value="ERROR [org.jboss.deployment.scanner.URLDeploymentScanner] Incomplete Deployment listing:"/>
         <arg value="ERROR [org.jboss.aop.deployment.AspectDeployer] failed to stop"/>
         <arg value="ERROR [org.jboss.ejb.plugins.LogInterceptor] TransactionRolledbackLocalException in method: public abstract void javax.jms.MessageListener.onMessage(javax.jms.Message), causedBy:"/>
         <arg value="ERROR [org.jboss.ejb.plugins.jms.JMSContainerInvoker] Exception in JMSCI message listener"/>
         <arg value="restart will delete it"/>
         <arg value="web-console.war/"/> <!-- Only on JBoss 5 -->
         <arg value="jmx-console.war/"/> <!-- Only on JBoss 5 -->
         <classpath>
            <pathelement location="../output/classes"/>
         </classpath>
      </java>

   </target>

   <target name="fail-on-serialization-debug-output">

      <java classname="org.jboss.test.messaging.tools.ant.FailOnSerializationDebugOutput">
         <arg value="${jboss.home}/server/${jboss.configuration}/log/server.log"/>
         <classpath>
            <pathelement location="../output/classes"/>
         </classpath>
      </java>

   </target>

   <target name="report">

      <java classname="org.jboss.test.messaging.tools.ant.GenerateSmokeReport">
         <arg value="-inputfile"/>
         <arg value="./output/smoke.log"/>
         <arg value="-outputdir"/>
         <arg value="./output"/>
         <arg value="-basename"/>
         <arg value="smoke-test-report"/>
         <arg value="-installerdir"/>
         <arg value="C:\work\jnlp"/>
         <arg value="-order"/>
         <arg value="queue,topic,http,secure-socket,mdb,mdb-failure,stateless,distributed-queue,distributed-topic,queue-failover"/>
         <classpath>
            <pathelement location="../output/classes"/>
         </classpath>
      </java>

   </target>

   <target name="clean">
      <delete dir="./output"/>
      <!--
          This also works on a clustered configuration when output/last-run.properties is correctly set.
      -->
      <antcall target="clean-messaging-config"/>
   </target>

   <target name="print-classpath">

      <pathconvert targetos="unix" property="classpath.tostring.property" refid="twiddle.classpath"/>
      <echo message="${classpath.tostring.property}"/>

   </target>

</project>

