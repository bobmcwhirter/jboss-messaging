<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id$ -->

<project default="smoke-test" name="Messaging Smoke Test">

   <property environment="ENV"/>
   <property name="sleep.interval" value="60"/>

   <path id="twiddle.classpath">
      <pathelement location="${ENV.JBOSS_HOME}/bin/twiddle.jar"/>
      <pathelement location="${ENV.JBOSS_HOME}/client/jbossall-client.jar"/>
      <pathelement location="${ENV.JBOSS_HOME}/client/getopt.jar"/>
      <pathelement location="${ENV.JBOSS_HOME}/client/log4j.jar"/>
      <pathelement location="${ENV.JBOSS_HOME}/lib/jboss-jmx.jar"/>
      <pathelement location="${ENV.JBOSS_HOME}/lib/dom4j.jar"/>
   </path>

   <target name="build-from-scratch">
      <ant dir="../.." antfile="build.xml" target="clean" inheritAll="false"/>
      <ant dir="../.." antfile="build.xml" target="sar-scoped" inheritAll="false"/>
   </target>

   <target name="validate-messaging-sar">
      <available property="messaging-sar"
         type="file" file="../../output/lib/jboss-messaging-scoped.sar"/>
      <fail unless="messaging-sar"
         message="../../output/lib/jboss-messaging-scoped.sar does not exist! Build it and try again"/>
   </target>

   <target name="validate-jboss-instance">
      <fail unless="ENV.JBOSS_HOME"
         message="JBOSS_HOME environment variable not set! Set it and try again"/>
      <available property="jboss-messaging-configuration"
         type="dir" file="${ENV.JBOSS_HOME}/server/messaging-smoke-test"/>
      <fail if="jboss-messaging-configuration"
         message="'messaging-smoke-test' configuration already exists. Delete it manually and try again"/>
   </target>

   <target name="create-messaging-configuration">
      <mkdir dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test"/>
      <copy todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test">
         <fileset dir="${ENV.JBOSS_HOME}/server/default"/>
      </copy>
      <copy file="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy/jms/jms-ra.rar"
         todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/data" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/log" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/tmp" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/work" quiet="yes"/>
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy/jms"/>
      <!-- add unauthenticated identity to "other" -->
      <replaceregexp file="${ENV.JBOSS_HOME}/server/messaging-smoke-test/conf/login-config.xml" flags="s">
         <regexp pattern="(\x3capplication-policy[ \t\n\r]+name[ \t\n\r]*=[ \t\n\r]*\x22other\x22.+flag[ \t\n\r]*=[ \t\n\r]*\x22required\x22)[ \t\n\r]*/\x3e"/>
         <substitution expression="\1>&lt;module-option name=&quot;unauthenticatedIdentity&quot;&gt;guest&lt;/module-option&gt;&lt;/login-module&gt;"/>
      </replaceregexp>
   </target>

   <target name="deploy-sar">
      <copy file="../../output/lib/jboss-messaging-scoped.sar"
         todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy"/>
   </target>

  <target name="start-jboss">
      <java classname="org.jboss.Main" fork="yes" spawn="yes" dir="${ENV.JBOSS_HOME}/bin">
         <jvmarg value="-server"/>
         <jvmarg value="-Xms128m"/>
         <jvmarg value="-Xmx128m"/>
         <arg value="-c"/>
         <arg value="messaging-smoke-test"/>
         <sysproperty key="java.endorsed.dirs" value="${ENV.JBOSS_HOME}/lib/endorsed"/>
         <classpath>
            <pathelement location="${ENV.JBOSS_HOME}/bin/run.jar"/>
            <pathelement location="${java.home}/lib/tools.jar"/>
         </classpath>
      </java>
   </target>

   <target name="stop-jboss">
      <java classname="org.jboss.Shutdown" fork="yes" dir="${ENV.JBOSS_HOME}/bin">
         <jvmarg value="-server"/>
         <jvmarg value="-Xms128m"/>
         <jvmarg value="-Xmx128m"/>
         <arg value="-S"/>
         <classpath>
            <pathelement location="${ENV.JBOSS_HOME}/bin/shutdown.jar"/>
            <pathelement location="${ENV.JBOSS_HOME}/client/jbossall-client.jar"/>
         </classpath>
      </java>
   </target>

   <!-- allow the server time to start/shut down -->
   <target name="sleep">
      <echo message="Sleeping for ${sleep.interval} seconds ..."/>
      <sleep seconds="${sleep.interval}"/>
   </target>

   <target name="ping-jms-server">
       <java classname="org.jboss.console.twiddle.Twiddle" fork="yes" failonerror="yes"
           dir="${ENV.JBOSS_HOME}/bin">
          <arg line="get jboss.messaging:service=ServerPeer serverPeerID"/>
          <classpath>
             <path refid="twiddle.classpath"/>
          </classpath>
       </java>
    </target>

   <target name="deploy-queue">
       <copy file="artifacts/smoketest-queue-service.xml"
         todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy"/>
   </target>

   <target name="ping-queue">
      <java classname="org.jboss.console.twiddle.Twiddle" fork="yes" failonerror="yes"
          dir="${ENV.JBOSS_HOME}/bin">
         <arg line="get jboss.messaging.destination:name=SmokeTestQueue,service=Queue QueueName"/>
         <classpath>
            <path refid="twiddle.classpath"/>
         </classpath>
      </java>
   </target>

   <target name="deploy-topic">
       <copy file="artifacts/smoketest-topic-service.xml"
         todir="${ENV.JBOSS_HOME}/server/messaging-smoke-test/deploy"/>
   </target>

   <target name="ping-topic">
      <java classname="org.jboss.console.twiddle.Twiddle" fork="yes" failonerror="yes"
          dir="${ENV.JBOSS_HOME}/bin">
         <arg line="get jboss.messaging.destination:name=SmokeTestTopic,service=Topic TopicName"/>
         <classpath>
            <path refid="twiddle.classpath"/>
         </classpath>
      </java>
   </target>

   <target name="queue-example">
      <ant dir="../../docs/examples/queue" antfile="build.xml" inheritAll="false">
         <property name="example.queue.name" value="SmokeTestQueue"/>
         <property name="messaging.deployment.archive.name" value="jboss-messaging-scoped.sar"/>
         <property name="jboss.configuration.name" value="messaging-smoke-test"/>
      </ant>
      <antcall target="clean-queue-example"/>
   </target>

   <target name="clean-queue-example">
      <ant dir="../../docs/examples/queue" antfile="build.xml" inheritAll="false" target="clean"/>
   </target>

   <target name="topic-example">
      <ant dir="../../docs/examples/topic" antfile="build.xml" inheritAll="false">
         <property name="example.topic.name" value="SmokeTestTopic"/>
         <property name="messaging.deployment.archive.name" value="jboss-messaging-scoped.sar"/>
         <property name="jboss.configuration.name" value="messaging-smoke-test"/>
      </ant>
      <antcall target="clean-topic-example"/>
   </target>

   <target name="clean-topic-example">
      <ant dir="../../docs/examples/topic" antfile="build.xml" inheritAll="false" target="clean"/>
   </target>

   <target name="mdb-example">
      <ant dir="../../docs/examples/mdb" antfile="build.xml" inheritAll="false">
         <property name="example.queue.name" value="SmokeTestQueue"/>
         <property name="messaging.deployment.archive.name" value="jboss-messaging-scoped.sar"/>
         <property name="jboss.configuration.name" value="messaging-smoke-test"/>
      </ant>
      <antcall target="clean-mdb-example"/>
   </target>

   <target name="clean-mdb-example">
      <ant dir="../../docs/examples/mdb" antfile="build.xml" inheritAll="false" target="clean">
         <property name="jboss.configuration.name" value="messaging-smoke-test"/>
      </ant>
   </target>

   <target name="stateless-example">
      <ant dir="../../docs/examples/stateless" antfile="build.xml" inheritAll="false">
         <property name="example.queue.name" value="SmokeTestQueue"/>
         <property name="messaging.deployment.archive.name" value="jboss-messaging-scoped.sar"/>
         <property name="jboss.configuration.name" value="messaging-smoke-test"/>
      </ant>
      <antcall target="clean-stateless-example"/>
   </target>

   <target name="clean-stateless-example">
      <ant dir="../../docs/examples/stateless" antfile="build.xml" inheritAll="false" target="clean">
         <property name="jboss.configuration.name" value="messaging-smoke-test"/>
      </ant>
   </target>

   <target name="clean">
      <delete dir="${ENV.JBOSS_HOME}/server/messaging-smoke-test" quiet="false" failonerror="true"/>
   </target>

   <target name="smoke-test">

      <antcall target="build-from-scratch"/>

      <antcall target="validate-messaging-sar"/>
      <antcall target="validate-jboss-instance"/>

      <antcall target="create-messaging-configuration"/>
      <antcall target="deploy-sar"/>

      <antcall target="start-jboss"/>
      <antcall target="sleep"><param name="sleep.interval" value="60"/></antcall>
      <antcall target="ping-jms-server"/>

      <antcall target="deploy-queue"/>
      <antcall target="sleep"><param name="sleep.interval" value="5"/></antcall>
      <antcall target="ping-queue"/>

      <antcall target="deploy-topic"/>
      <antcall target="sleep"><param name="sleep.interval" value="5"/></antcall>
      <antcall target="ping-topic"/>


      <antcall target="queue-example"/>
      <antcall target="topic-example"/>
      <antcall target="mdb-example"/>
      <antcall target="stateless-example"/>

      <antcall target="stop-jboss"/>
      <antcall target="sleep"><param name="sleep.interval" value="30"/></antcall>
      <antcall target="clean"/>
   </target>

</project>

